<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh L·∫•y Comment YouTube</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh font ch·ªØ Inter */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* --- CSS CHO C√îNG C·ª§ COMMENT --- */
        .page-container {
            display: flex;
            justify-content: center;
            padding: 24px;
        }
        .comment-tool-container { 
            width:100%; 
            max-width:1120px; 
            background:#fff; 
            padding:24px; 
            border-radius:14px; 
            box-shadow:0 10px 28px rgba(0,0,0,.06);
        }
        .comment-tool-container h1 { 
            margin:0 0 18px; 
            text-align:center; 
            color:#d32f2f; 
            font-weight:800; 
            font-size: 1.875rem; /* text-3xl */
        }
        .comment-row { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap }
        .comment-row .field { flex:1; min-width:260px }
        .comment-input[type="text"] { width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:15px; outline:none; }
        .comment-btn { 
            padding:12px 18px; 
            font-size:15px; 
            background:#ff0000; 
            color:#fff; 
            border:none; 
            border-radius:10px; 
            cursor:pointer; 
            transition:.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .comment-btn:hover { background:#c00000 }
        .comment-btn:disabled { background:#cfcfcf; cursor:not-allowed }
        
        /* N√∫t ch·ªçn ng√¥n ng·ªØ M·ªöI */
        .lang-select-btn {
            padding: 12px 14px; font-size: 15px; background: #fff; color: #333;
            border: 1px solid #ddd; border-radius: 10px; cursor: pointer;
            transition: .2s; position: relative; white-space: nowrap;
        }
        .lang-select-btn:hover { background: #f9f9f9; }
        .lang-select-btn span { color: #1d4ed8; font-weight: 600; }
        .lang-dropdown {
            display: none; position: absolute; bottom: 100%; /* Hi·ªÉn th·ªã b√™n tr√™n n√∫t */
            left: 0; right: 0; background: #fff; border: 1px solid #ddd;
            border-radius: 10px; padding: 8px; max-height: 200px;
            overflow-y: auto; z-index: 10; box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }
        .lang-dropdown.show { display: block; }
        .lang-option {
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
        }
        .lang-option:hover { background-color: #f3f4f6; }
        .lang-option.selected { background-color: #dbeafe; color: #1d4ed8; font-weight: 600; }

        .sort-bar { display:none; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 6px }
        .sort-title { font-weight:700; color:#444 }
        .sort-btn { border:1px solid #e5e7eb; background:#fff; color:#333; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:14px }
        .sort-btn.active { border-color:#d32f2f; color:#d32f2f; font-weight:800 }
        .sort-hint { margin-left:auto; color:#888; font-size:12px }
        #comment-status { text-align:center; font-size:14px; color:#777; margin:8px 0 0 }
        #comment-results { margin-top:4px }
        .comment-thread { border-bottom:1px solid #e9e9ef; padding:16px 0 }
        .comment-thread:last-child { border-bottom:none }
        .thread-row { display:grid; grid-template-columns: 1fr 300px; gap:16px; align-items:start }
        .left-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px }
        .left-col { border:1px solid #e9e9ef; border-radius:12px; background:#fafafa; padding:12px }
        .left-col h3 { margin:0 0 10px; font-size:14px; color:#555; font-weight:800 }
        .comment { display:flex; align-items:flex-start; gap:12px }
        .comment + .comment { margin-top:10px }
        .comment-author-img { width:40px; height:40px; border-radius:50%; background-color: #eee; }
        .comment-content { flex:1 }
        .comment-author { font-weight:800; margin-bottom:5px }
        .replies-container { margin-left:52px; margin-top:12px; border-left:2px solid #e0e0e0; padding-left:12px }
        .reply .comment-author-img { width:30px; height:30px }
        .reply { margin-top:8px }
        .thread-right { border:1px solid #e9e9ef; border-radius:12px; padding:12px; background:#fafafa }
        .metrics-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
        .metric { text-align:center; padding:10px 8px; border-radius:10px; background:#fff; border:1px solid #f0f0f0 }
        .metric-label { font-size:12px; color:#666; margin-bottom:4px }
        .metric-value { font-weight:800; font-size:16px; word-break:break-word }
        @media (max-width: 980px){ .thread-row{ grid-template-columns:1fr } .thread-right { margin-top: 16px; } }
        @media (max-width: 720px){ .left-grid{ grid-template-columns:1fr } }

        /* Hi·ªáu ·ª©ng loading chung */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Trang 2: Tr√¨nh L·∫•y Comment YouTube (M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã) -->
    <div id="page-comments" class="page-container">
        <div class="comment-tool-container">
            <h1>üìù Tr√¨nh L·∫•y Comment YouTube</h1>
            <!-- H√†ng nh·∫≠p URL video -->
            <div class="comment-row">
                <div class="field"><input id="comment-video-url" class="comment-input" type="text" placeholder="D√°n link video YouTube v√†o ƒë√¢y..."></div>
                
                <!-- N√∫t ch·ªçn ng√¥n ng·ªØ M·ªöI -->
                <div class="relative">
                    <button id="lang-select-btn" class="lang-select-btn" type="button">
                        D·ªãch sang: <span>Ti·∫øng Vi·ªát</span>
                        <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="lang-dropdown" class="lang-dropdown">
                        <!-- C√°c ng√¥n ng·ªØ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                    </div>
                </div>

                <button id="comment-search-button" class="comment-btn">T√¨m ki·∫øm</button>
            </div>
            <!-- Thanh s·∫Øp x·∫øp -->
            <div class="sort-bar" id="comment-sort-bar">
                <span class="sort-title">S·∫Øp x·∫øp theo:</span>
                <button class="sort-btn" id="sort-like">Like ‚Üì</button>
                <button class="sort-btn" id="sort-replies">Cmt c·∫•p 2 ‚Üì</button>
                <button class="sort-btn" id="sort-date">Ng√†y ‚Üì</button>
                <span class="sort-hint">B·∫•m l·∫°i n√∫t ƒë·ªÉ ƒë·∫£o chi·ªÅu ‚Üë/‚Üì</span>
            </div>
            <div id="comment-status"></div>
            <div id="comment-results"></div>
        </div>
    </div>


    <script>
        // SCRIPT CHUNG: QU·∫¢N L√ù CHUY·ªÇN TRANG
        document.addEventListener('DOMContentLoaded', () => {
            // KH√îNG C√íN HUB N·ªÆA, CH·∫†Y TR·ª∞C TI·∫æP
            initCommentsTool();
        });

        // ==================================================================
        // === SCRIPT CHO C√îNG C·ª§ COMMENT (Comments Tool) ===
        // ==================================================================
        function initCommentsTool() {
            // ===== UI refs =====
            const searchButton = document.getElementById('comment-search-button');
            const videoUrlInput = document.getElementById('comment-video-url');
            const resultsDiv = document.getElementById('comment-results');
            const statusDiv = document.getElementById('comment-status');
            const sortBar = document.getElementById('comment-sort-bar');
            const btnSortLike = document.getElementById('sort-like');
            const btnSortReplies = document.getElementById('sort-replies');
            const btnSortDate = document.getElementById('sort-date');
            
            // --- C√ÅC BI·∫æN CHO N√öT NG√îN NG·ªÆ ---
            const langSelectBtn = document.getElementById('lang-select-btn');
            const langDropdown = document.getElementById('lang-dropdown');
            const langBtnText = langSelectBtn.querySelector('span');
            let targetLang = 'vi'; // Ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh
            let targetLangName = 'Ti·∫øng Vi·ªát';

            const languages = [
                { code: 'vi', name: 'Ti·∫øng Vi·ªát' },
                { code: 'en', name: 'Ti·∫øng Anh' },
                { code: 'es', name: 'Ti·∫øng T√¢y Ban Nha' },
                { code: 'fr', name: 'Ti·∫øng Ph√°p' },
                { code: 'de', name: 'Ti·∫øng ƒê·ª©c' },
                { code: 'ja', name: 'Ti·∫øng Nh·∫≠t' },
                { code: 'ko', name: 'Ti·∫øng H√†n' },
                { code: 'zh-CN', name: 'Ti·∫øng Trung (Gi·∫£n th·ªÉ)' },
                { code: 'ru', name: 'Ti·∫øng Nga' },
                { code: 'pt', name: 'Ti·∫øng B·ªì ƒê√†o Nha' }
            ];

            // --- Kh·ªüi t·∫°o danh s√°ch ng√¥n ng·ªØ ---
            function initLanguageDropdown() {
                if(!langDropdown) return;
                langDropdown.innerHTML = '';
                languages.forEach(lang => {
                    const option = document.createElement('div');
                    option.className = 'lang-option';
                    option.textContent = lang.name;
                    option.dataset.code = lang.code;
                    option.dataset.name = lang.name;
                    if (lang.code === targetLang) {
                        option.classList.add('selected');
                    }
                    option.addEventListener('click', () => {
                        // C·∫≠p nh·∫≠t state
                        targetLang = lang.code;
                        targetLangName = lang.name;
                        
                        // C·∫≠p nh·∫≠t UI
                        langBtnText.textContent = lang.name;
                        langDropdown.querySelectorAll('.lang-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        langDropdown.classList.remove('show');
                    });
                    langDropdown.appendChild(option);
                });
            }

            // --- G√°n s·ª± ki·ªán cho n√∫t ng√¥n ng·ªØ ---
            if(langSelectBtn) {
                initLanguageDropdown();

                langSelectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langDropdown.classList.toggle('show');
                });
                
                // ƒê√≥ng dropdown khi click ra ngo√†i
                document.addEventListener('click', (e) => {
                    if (langSelectBtn && !langSelectBtn.contains(e.target) && langDropdown && !langDropdown.contains(e.target)) {
                        langDropdown.classList.remove('show');
                    }
                });
            }

            // ===== State =====
            let allThreads = [];
            let sortKey = 'date'; // 'like' | 'replies' | 'date'
            let sortDir = 'desc'; // 'asc' | 'desc'
            let allCommentTexts = []; // M·∫£ng ch·ª©a to√†n b·ªô vƒÉn b·∫£n g·ªëc
            let allTranslations = []; // M·∫£ng ch·ª©a to√†n b·ªô vƒÉn b·∫£n d·ªãch
            let currentTranslationHeader = 'B·∫£n d·ªãch (vi)'; // Bi·∫øn l∆∞u ti√™u ƒë·ªÅ c·ªôt d·ªãch

            // ===== Translation (Backend) =====
            async function translateBatchToVi(texts, langCode) {
                if (!texts || texts.length === 0) return [];
                
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c·ªôt d·ªãch
                // L·∫•y t√™n ng√¥n ng·ªØ t·ª´ m√£ code
                const langName = languages.find(l => l.code === langCode)?.name || langCode;
                currentTranslationHeader = `B·∫£n d·ªãch (${langName})`;
                statusDiv.textContent = `ƒêang d·ªãch ${texts.length} b√¨nh lu·∫≠n sang ${langName}... (ch·ªâ 1 l·∫ßn)`;
                
                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texts: texts, targetLang: langCode }) // G·ª≠i ng√¥n ng·ªØ ƒë√£ ch·ªçn
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'L·ªói d·ªãch');
                    }
                    
                    const data = await response.json();
                    return data.translations || texts.map(() => '(Ch∆∞a d·ªãch)');

                } catch (e) {
                    console.error('L·ªói g·ªçi backend d·ªãch:', e);
                    statusDiv.textContent = `L·ªói d·ªãch: ${e.message}`;
                    return texts.map(() => '(L·ªói d·ªãch)');
                }
            }

            // ===== Sort handlers =====
            function attachSortHandlers() {
                function activate(btn) { [btnSortLike, btnSortReplies, btnSortDate].forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
                function toggleDir(btn, label) { sortDir = (sortDir === 'desc') ? 'asc' : 'desc'; btn.textContent = `${label} ${sortDir === 'desc' ? '‚Üì' : '‚Üë'}`; }

                if (btnSortLike.hasAttribute('data-inited')) return; // ƒê√£ g√°n r·ªìi

                btnSortLike.addEventListener('click', () => {
                    if (sortKey !== 'like') { sortKey = 'like'; sortDir = 'desc'; btnSortLike.textContent = 'Like ‚Üì'; } 
                    else toggleDir(btnSortLike, 'Like');
                    activate(btnSortLike); renderThreads();
                });
                btnSortReplies.addEventListener('click', () => {
                    if (sortKey !== 'replies') { sortKey = 'replies'; sortDir = 'desc'; btnSortReplies.textContent = 'Cmt c·∫•p 2 ‚Üì'; } 
                    else toggleDir(btnSortReplies, 'Cmt c·∫•p 2');
                    activate(btnSortReplies); renderThreads();
                });
                btnSortDate.addEventListener('click', () => {
                    if (sortKey !== 'date') { sortKey = 'date'; sortDir = 'desc'; btnSortDate.textContent = 'Ng√†y ‚Üì'; } 
                    else toggleDir(btnSortDate, 'Ng√†y');
                    activate(btnSortDate); renderThreads();
                });
                
                btnSortDate.classList.add('active'); // K√≠ch ho·∫°t m·∫∑c ƒë·ªãnh
                btnSortLike.setAttribute('data-inited', '1');
            }

            // ===== Search flow =====
            if(searchButton) { // Ch·ªâ g√°n s·ª± ki·ªán n·∫øu n√∫t t·ªìn t·∫°i
                searchButton.addEventListener('click', async () => {
                    const videoURL = videoUrlInput.value.trim();
                    if (!videoURL) { alert('Vui l√≤ng nh·∫≠p link video YouTube.'); return; }
                    const videoId = getYoutubeId(videoURL);
                    if (!videoId) { alert('Link video kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.'); return; }

                    // Reset
                    searchButton.disabled = true; 
                    searchButton.innerHTML = '<div class="loader" style="width: 20px; height: 20px; border-width: 3px;"></div>'; // Loader nh·ªè h∆°n
                    resultsDiv.innerHTML = ''; statusDiv.textContent = 'ƒêang l·∫•y d·ªØ li·ªáu, vui l√≤ng ch·ªù...';
                    allThreads = []; allCommentTexts = []; allTranslations = [];
                    sortBar.style.display = 'none';

                    try {
                        // 1. L·∫•y t·∫•t c·∫£ b√¨nh lu·∫≠n
                        await fetchAllComments(videoId);
                        
                        if (allThreads.length === 0) {
                            statusDiv.textContent = 'Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n n√†o ho·∫∑c video ƒë√£ t·∫Øt b√¨nh lu·∫≠n.';
                            searchButton.disabled = false; searchButton.textContent = 'T√¨m ki·∫øm'; // Ph·ª•c h·ªìi n√∫t
                            return;
                        }
                        
                        // 2. T·ªêI ∆ØU: D·ªãch t·∫•t c·∫£ 1 l·∫ßn (s·ª≠ d·ª•ng targetLang)
                        allTranslations = await translateBatchToVi(allCommentTexts, targetLang);

                        // 3. Hi·ªÉn th·ªã
                        statusDiv.textContent = `ƒê√£ t·∫£i v√† d·ªãch xong ${allThreads.length} lu·ªìng b√¨nh lu·∫≠n!`;
                        attachSortHandlers();
                        sortBar.style.display = 'flex';
                        renderThreads(); // Render l·∫ßn ƒë·∫ßu (ƒë√£ d·ªãch)
                        
                    } catch (e) {
                        console.error('L·ªói:', e);
                        statusDiv.textContent = `ƒê√£ x·∫£y ra l·ªói: ${e.message}`;
                    } finally {
                        searchButton.disabled = false; searchButton.textContent = 'T√¨m ki·∫øm';
                    }
                });
            }

            function getYoutubeId(url) {
                const re = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const m = url.match(re); return m ? m[1] : null;
            }

            // ===== Fetch comments (paginate) =====
            async function fetchAllComments(videoId, pageToken = '') {
                statusDiv.textContent = `ƒêang t·∫£i b√¨nh lu·∫≠n... (ƒë√£ t·∫£i ${allThreads.length} lu·ªìng)`;
                
                // G·ªçi backend /api/youtube-comments
                const response = await fetch('/api/youtube-comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: videoId, pageToken: pageToken })
                });

                if (!response.ok) {
                    const errText = await response.text(); // L·∫•y l·ªói text
                    console.error("L·ªói fetchAllComments:", errText);
                    let errMessage = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
                    try {
                        const errJson = JSON.parse(errText); // Th·ª≠ parse JSON
                        errMessage = errJson.message || errText;
                    } catch(e) {
                        errMessage = errText; // N·∫øu kh√¥ng ph·∫£i JSON, d√πng text
                    }
                    throw new Error(errMessage);
                }

                const data = await response.json();
                
                if (data.items) {
                    collectThreads(data.items);
                }
                
                // ƒê·ªá quy n·∫øu c√≥ trang ti·∫øp theo
                if (data.nextPageToken) {
                    await fetchAllComments(videoId, data.nextPageToken);
                }
            }

            // T·ªêI ∆ØU: T√°ch bi·ªát vi·ªác Thu th·∫≠p (Collect) v√† D·ªãch (Translate)
            function collectThreads(items) {
                items.forEach(item => {
                    const top = item.snippet.topLevelComment?.snippet || {};
                    const likeCount = Number(top.likeCount || 0);
                    const totalReplies = Number(item.snippet.totalReplyCount || 0);
                    const publishedAtISO = top.publishedAt || null;
                    const publishedDate = publishedAtISO ? new Date(publishedAtISO) : null;
                    
                    const threadObj = {
                        raw: item,
                        likeCount, totalReplies,
                        publishedAtISO, publishedDate,
                        translationIndexStart: allCommentTexts.length // V·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa b·∫£n d·ªãch
                    };

                    // Thu th·∫≠p vƒÉn b·∫£n g·ªëc (top level)
                    allCommentTexts.push(top.textOriginal || '');
                    
                    // Thu th·∫≠p vƒÉn b·∫£n g·ªëc (replies)
                    (item.replies?.comments || []).forEach(r => {
                        allCommentTexts.push(r.snippet?.textOriginal || '');
                    });
                    
                    allThreads.push(threadObj);
                });
            }

            // ===== Render (ch·ªâ s·∫Øp x·∫øp v√† hi·ªÉn th·ªã) =====
            function renderThreads() {
                // S·∫Øp x·∫øp
                const arr = [...allThreads];
                arr.sort((a, b) => {
                    let va, vb;
                    if (sortKey === 'like') { va = a.likeCount; vb = b.likeCount; } 
                    else if (sortKey === 'replies') { va = a.totalReplies; vb = b.totalReplies; } 
                    else {
                        va = a.publishedDate ? a.publishedDate.getTime() : 0;
                        vb = b.publishedDate ? b.publishedDate.getTime() : 0;
                    }
                    return (sortDir === 'desc') ? (vb - va) : (va - vb);
                });

                // Render
                resultsDiv.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©
                for (const obj of arr) {
                    // B√¢y gi·ªù ch·ªâ c·∫ßn t·∫°o DOM, kh√¥ng c·∫ßn ch·ªù d·ªãch
                    resultsDiv.appendChild(createThreadDOM(obj));
                }
            }

            // ===== DOM builders =====
            function createThreadDOM(threadObj) {
                const { raw, likeCount, totalReplies, publishedAtISO, publishedDate, translationIndexStart } = threadObj;
                const top = raw.snippet.topLevelComment.snippet;

                const threadDiv = document.createElement('div'); threadDiv.className = 'comment-thread';
                const rowDiv = document.createElement('div'); rowDiv.className = 'thread-row';

                // Tr√°i: 2 c·ªôt (Nguy√™n b·∫£n | D·ªãch)
                const leftWrap = document.createElement('div'); leftWrap.className = 'left-grid';

                // C·ªôt Nguy√™n b·∫£n
                const colOriginal = document.createElement('div'); colOriginal.className = 'left-col';
                colOriginal.innerHTML = `<h3>Nguy√™n b·∫£n</h3>`;
                colOriginal.appendChild(createCommentElement(top, false, null)); // textDisplay g·ªëc
                if (raw.replies) {
                    const rep = document.createElement('div'); rep.className = 'replies-container';
                    raw.replies.comments.forEach(r => rep.appendChild(createCommentElement(r.snippet, true, null)) );
                    colOriginal.appendChild(rep);
                }

                // C·ªôt D·ªãch (l·∫•y t·ª´ m·∫£ng ƒë√£ d·ªãch)
                const colTranslated = document.createElement('div'); colTranslated.className = 'left-col';
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c·ªôt d·ªãch
                colTranslated.innerHTML = `<h3>${currentTranslationHeader}</h3>`; 
                
                // L·∫•y b·∫£n d·ªãch cho top-level comment
                let translationIndex = translationIndexStart;
                const topLevelTranslation = allTranslations[translationIndex] || '(Ch∆∞a d·ªãch)';
                colTranslated.appendChild(createCommentElement(top, false, topLevelTranslation));
                translationIndex++; // TƒÉng ch·ªâ s·ªë
                
                if (raw.replies) {
                    const repVi = document.createElement('div'); repVi.className = 'replies-container';
                    raw.replies.comments.forEach(r => {
                        const replyTranslation = allTranslations[translationIndex] || '(Ch∆∞a d·ªãch)';
                        repVi.appendChild(createCommentElement(r.snippet, true, replyTranslation));
                        translationIndex++; // TƒÉng ch·ªâ s·ªë cho m·ªói reply
                    });
                    colTranslated.appendChild(repVi);
                }

                leftWrap.appendChild(colOriginal);
                leftWrap.appendChild(colTranslated);

                // Ph·∫£i: 3 ch·ªâ s·ªë
                const rightDiv = document.createElement('div'); rightDiv.className = 'thread-right';
                const metrics = document.createElement('div'); metrics.className = 'metrics-grid';

                const likeBox = document.createElement('div'); likeBox.className = 'metric';
                likeBox.innerHTML = `<div class="metric-label">Like (c·∫•p 1)</div><div class="metric-value">${likeCount.toLocaleString('vi-VN')}</div>`;
                const replyBox = document.createElement('div'); replyBox.className = 'metric';
                replyBox.innerHTML = `<div class="metric-label">Cmt c·∫•p 2</div><div class="metric-value">${totalReplies.toLocaleString('vi-VN')}</div>`;
                const dateBox = document.createElement('div'); dateBox.className = 'metric';
                const dateText = publishedDate ? publishedDate.toLocaleString('vi-VN', { hour12: false }) : '‚Äî';
                dateBox.innerHTML = `<div class="metric-label">Ng√†y</div><div class="metric-value" title="${publishedAtISO || ''}">${dateText}</div>`;

                metrics.appendChild(likeBox); metrics.appendChild(replyBox); metrics.appendChild(dateBox);
                rightDiv.appendChild(metrics);

                rowDiv.appendChild(leftWrap);
                rowDiv.appendChild(rightDiv);
                threadDiv.appendChild(rowDiv);
                return threadDiv;
            }

            function createCommentElement(snippet, isReply = false, overrideText = null) {
                const wrap = document.createElement('div'); wrap.className = isReply ? 'comment reply' : 'comment';
                const avatar = document.createElement('img');
                avatar.className = 'comment-author-img'; 
                avatar.src = snippet.authorProfileImageUrl; 
                avatar.alt = 'Avatar';
                avatar.onerror = () => { avatar.src = 'https://placehold.co/40x40/eee/ccc?text=?'; }; // ·∫¢nh placeholder n·∫øu l·ªói
                
                const content = document.createElement('div'); content.className = 'comment-content';
                const author = document.createElement('div'); author.className = 'comment-author';
                author.textContent = snippet.authorDisplayName || '(Kh√¥ng r√µ)';
                
                const text = document.createElement('div');
                text.style.whiteSpace = 'pre-wrap'; // Gi·ªØ xu·ªëng d√≤ng
                text.style.wordBreak = 'break-word'; // Ng·∫Øt t·ª´
                
                if (overrideText !== null) { 
                    text.textContent = overrideText; // Hi·ªÉn th·ªã text thu·∫ßn (ƒë√£ d·ªãch)
                } else { 
                    text.innerHTML = snippet.textDisplay || snippet.textOriginal; // Hi·ªÉn th·ªã HTML g·ªëc
                }

                content.appendChild(author); content.appendChild(text);
                wrap.appendChild(avatar); wrap.appendChild(content);
                return wrap;
            }
        } // K·∫øt th√∫c initCommentsTool()
    </script>
</body>
</html>

