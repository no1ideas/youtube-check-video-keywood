<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh T√¨m Ki·∫øm & Ph√¢n T√≠ch Video K√™nh YouTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Th√™m style ƒë·ªÉ x·ª≠ l√Ω cu·ªôn ngang tr√™n container filter n·∫øu c·∫ßn */
        .filter-container-wrapper {
            overflow-x: auto;
            /* ·∫®n thanh cu·ªôn tr√™n Firefox */
            scrollbar-width: none; 
        }
        /* ·∫®n thanh cu·ªôn tr√™n Chrome/Safari/Edge */
        .filter-container-wrapper::-webkit-scrollbar {
            display: none; 
        }

        /* ƒê·∫£m b·∫£o spinner (bi·ªÉu t∆∞·ª£ng t·∫£i) quay */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* [S·ª¨A] Style cho container bi·ªÉu ƒë·ªì (thanh) */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px; /* C·ªë ƒë·ªãnh chi·ªÅu cao cho bi·ªÉu ƒë·ªì c·ªôt */
            margin: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl">

            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">
                Tr√¨nh T√¨m Ki·∫øm & Ph√¢n T√≠ch Video K√™nh YouTube
            </h1>

            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="urlInput" class="flex-grow px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="D√°n link k√™nh (v√≠ d·ª•: /channel/..., @handle, /c/...)">
                <button id="searchButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all active:transform active:scale-95 text-base">
                    T√¨m ki·∫øm
                </button>
            </div>

            <div id="filterContainerWrapper" class="hidden filter-container-wrapper py-2 mb-4">
                <div id="filterContainer" class="bg-gray-50 rounded-lg flex items-center justify-start md:justify-between gap-4 p-4 flex-nowrap min-w-max">
                    
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <label for="yearFilter" class="text-gray-700 font-medium">L·ªçc theo nƒÉm:</label>
                        <select id="yearFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="0">T·∫•t c·∫£ nƒÉm</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <label for="viewsFilter" class="text-gray-700 font-medium">L·ªçc l∆∞·ª£t xem:</label>
                        <select id="viewsFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="0">T·∫•t c·∫£ (M·ªõi nh·∫•t)</option>
                            <option value="3">Top 3 xem nhi·ªÅu nh·∫•t</option>
                            <option value="5">Top 5 xem nhi·ªÅu nh·∫•t</option>
                            <option value="10">Top 10 xem nhi·ªÅu nh·∫•t</option>
                            <option value="15">Top 15 xem nhi·ªÅu nh·∫•t</option>
                            <option value="20">Top 20 xem nhi·ªÅu nh·∫•t</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <label for="videoTypeFilter" class="text-gray-700 font-medium">L·ªçc lo·∫°i video:</label>
                        <select id="videoTypeFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="long">Video d√†i</option>
                            <option value="short">Video ng·∫Øn</option>
                            <option value="live">Ph√°t tr·ª±c ti·∫øp</option>
                        </select>
                    </div>

                    <button id="toggleKeywordsButton" class="flex-shrink-0 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-all active:transform active:scale-95">
                        Hi·ªán T·ª´ kh√≥a
                    </button>
                </div>
            </div>

            <div id="analysisButtonContainer" class="hidden mb-4 py-2">
                <button id="analysisButton" class="w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-all active:transform active:scale-95 text-base">
                    üìä Ph√¢n t√≠ch K√™nh
                </button>
            </div>

            <div id="analysisResults" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-6">Ph√¢n T√≠ch Th√≥i Quen ƒêƒÉng Video (Chi Ti·∫øt)</h2>
                
                <div class="flex flex-wrap -mx-4">
                    <div class="w-full lg:w-1/3 px-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-md h-full">
                            <h3 class="text-base font-bold text-center text-gray-700 mb-2">Ph√¢n t√≠ch Gi·ªù c√¥ng chi·∫øu</h3>
                            <div class="chart-container">
                                <canvas id="chartHour"></canvas>
                            </div>
                            <div id="chartHourMeaning" class="mt-4 text-sm text-gray-700 bg-blue-50 p-3 rounded-md"></div>
                            <div id="chartHourRecommendation" class="mt-3 text-sm text-purple-700 bg-purple-50 p-3 rounded-md"></div>
                        </div>
                    </div>
                    
                    <div class="w-full lg:w-1/3 px-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-md h-full">
                            <h3 class="text-base font-bold text-center text-gray-700 mb-2">Ph√¢n t√≠ch Th·ª© trong tu·∫ßn</h3>
                            <div class="chart-container">
                                <canvas id="chartDayOfWeek"></canvas>
                            </div>
                            <div id="chartDayOfWeekMeaning" class="mt-4 text-sm text-gray-700 bg-green-50 p-3 rounded-md"></div>
                            <div id="chartDayOfWeekRecommendation" class="mt-3 text-sm text-indigo-700 bg-indigo-50 p-3 rounded-md"></div>
                        </div>
                    </div>

                    <div class="w-full lg:w-1/3 px-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-md h-full">
                            <h3 class="text-base font-bold text-center text-gray-700 mb-2">Ph√¢n t√≠ch Ng√†y trong th√°ng</h3>
                            <div class="chart-container">
                                <canvas id="chartDayOfMonth"></canvas>
                            </div>
                            <div id="chartDayOfMonthMeaning" class="mt-4 text-sm text-gray-700 bg-yellow-50 p-3 rounded-md"></div>
                            <div id="chartDayOfMonthRecommendation" class="mt-3 text-sm text-teal-700 bg-teal-50 p-3 rounded-md"></div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="error" class="hidden my-4 p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg"></div>
            <div id="status" class="hidden my-4 p-4 bg-blue-100 text-blue-700 border border-blue-300 rounded-lg flex items-center justify-center gap-3">
                <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8
 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="statusText">ƒêang t·∫£i...</span>
            </div>
            
            <div id="copySuccess" class="hidden fixed bottom-5 right-5 p-3 bg-green-500 text-white rounded-lg shadow-lg transition-opacity duration-300 z-50">
                ƒê√£ sao ch√©p!
            </div>

            <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
                </div>

        </div>
    </div>

    <script>
        // === KHAI B√ÅO BI·∫æN ===
        
        const API_KEY = 'AIzaSyC1mzDrkg89zonJ1bt2mGFCF-nEA7qMZuU';
        
        // DOM Elements
        const urlInput = document.getElementById('urlInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('results');
        const errorContainer = document.getElementById('error');
        const statusContainer = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const filterContainerWrapper = document.getElementById('filterContainerWrapper');
        const yearFilter = document.getElementById('yearFilter');
        const viewsFilter = document.getElementById('viewsFilter');
        const videoTypeFilter = document.getElementById('videoTypeFilter');
        const toggleKeywordsButton = document.getElementById('toggleKeywordsButton');
        const copySuccessMessage = document.getElementById('copySuccess');

        // [M·ªöI] DOM Elements cho Ph√¢n t√≠ch
        const analysisButtonContainer = document.getElementById('analysisButtonContainer');
        const analysisButton = document.getElementById('analysisButton');
        const analysisResults = document.getElementById('analysisResults');

        // Bi·∫øn to√†n c·ª•c
        let allFetchedVideos = [];
        let showKeywords = false;
        let copyTimeout = null;
        let chartInstances = {}; // L∆∞u tr·ªØ bi·ªÉu ƒë·ªì ƒë·ªÉ h·ªßy

        // [S·ª¨A] M·∫£ng m√†u (ch·ªß y·∫øu d√πng cho bi·ªÉu ƒë·ªì c·ªôt)
        const CHART_COLORS = {
            blue: 'rgba(59, 130, 246, 0.7)',
            green: 'rgba(16, 185, 129, 0.7)',
            yellow: 'rgba(245, 159, 11, 0.7)',
        };
        
        const WEEKDAY_NAMES = [
            'Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'
        ];

        // [M·ªöI] Nh√£n cho bi·ªÉu ƒë·ªì chi ti·∫øt
        const HOUR_LABELS = Array.from({ length: 24 }, (_, i) => {
            const h1 = String(i).padStart(2, '0');
            const h2 = String(i + 1).padStart(2, '0');
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p 23:00 - 24:00
            return `${h1}:00 - ${h2 === '24' ? '00' : h2}:00`;
        });

        const DAY_OF_MONTH_LABELS = Array.from({ length: 31 }, (_, i) => `Ng√†y ${i + 1}`);


        // === G·∫ÆN S·ª∞ KI·ªÜN ===
        searchButton.addEventListener('click', handleSearch);
        yearFilter.addEventListener('change', renderFilteredVideos);
        viewsFilter.addEventListener('change', renderFilteredVideos);
        videoTypeFilter.addEventListener('change', renderFilteredVideos);
        toggleKeywordsButton.addEventListener('click', handleToggleKeywords);
        analysisButton.addEventListener('click', handleAnalysis); // [M·ªöI]
        urlInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSearch());
        resultsContainer.addEventListener('click', handleCopyClick);
        
        // === C√ÅC H√ÄM CH√çNH ===

        function parseISODuration(durationString) {
            if (!durationString) return 0;
            const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
            const matches = durationString.match(regex);
            if (!matches) return 0;
            const hours = parseInt(matches[1] || 0, 10);
            const minutes = parseInt(matches[2] || 0, 10);
            const seconds = parseInt(matches[3] || 0, 10);
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        // [S·ª¨A] H√†m ƒë·ªãnh d·∫°ng ng√†y gi·ªù (theo y√™u c·∫ßu m·ªõi)
        function formatFullDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const weekday = WEEKDAY_NAMES[date.getDay()];
            return `${hours}:${minutes}, ${weekday}, ${day}/${month}/${year}`;
        }

        async function handleSearch() {
            const url = urlInput.value.trim();
            if (!url) {
                showError('Vui l√≤ng nh·∫≠p URL k√™nh YouTube.');
                return;
            }

            clearResults();
            showStatus('ƒêang t√¨m ki·∫øm Channel ID...');

            try {
                const channelId = await getChannelId(url);
                if (!channelId) return;
                
                showStatus('ƒê√£ t√¨m th·∫•y k√™nh! ƒêang l·∫•y danh s√°ch video... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)');
                const uploadsPlaylistId = channelId.replace('UC', 'UU');
                const videos = await getVideosFromPlaylist(uploadsPlaylistId);
                
                if (videos.length === 0) {
                    showError('K√™nh n√†y kh√¥ng c√≥ video c√¥ng khai n√†o.');
                    hideStatus();
                    return;
                }
                
                showStatus(`ƒê√£ t·∫£i ${videos.length} video. ƒêang l·∫•y l∆∞·ª£t xem v√† t·ª´ kh√≥a...`);
                const videoDetailsMap = await getVideoDetails(videos);

                allFetchedVideos = videos.map(video => {
                    const videoId = video.snippet.resourceId.videoId;
                    const details = videoDetailsMap.get(videoId) || { 
                        viewCount: 0, tags: [], duration: 'PT0S', liveBroadcastContent: 'none' 
                    };
                    
                    const duration = details.duration || 'PT0S';
                    const liveContent = details.liveBroadcastContent || 'none';
                    let videoType = 'long';
                    
                    const seconds = parseISODuration(duration);
                    if (liveContent === 'live' || liveContent === 'upcoming') videoType = 'live';
                    else if (seconds > 0 && seconds <= 60) videoType = 'short';

                    return {
                        ...video,
                        viewCount: parseInt(details.viewCount || 0, 10),
                        tags: details.tags,
                        videoType: videoType
                    };
                });

                populateFilters(allFetchedVideos);
                renderFilteredVideos();
                
                filterContainerWrapper.classList.remove('hidden');
                analysisButtonContainer.classList.remove('hidden'); // [M·ªöI]
                hideStatus();

            } catch (error) {
                console.error('L·ªói trong handleSearch:', error);
                showError('ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh. Ki·ªÉm tra Console (F12).');
                hideStatus();
            }
        }

        async function getChannelId(url) {
            let searchTerm = '';
            let searchType = 'id';

            const handleMatch = url.match(/youtube\.com\/@([^/?&]+)/);
            const legacyMatch = url.match(/youtube\.com\/c\/([^/?&]+)/);
            const channelMatch = url.match(/youtube\.com\/channel\/(UC[^/?&]+)/);
            
            if (channelMatch) return channelMatch[1];
            else if (handleMatch) {
                searchTerm = handleMatch[1];
                searchType = 'forHandle';
            } else if (legacyMatch) {
                searchTerm = decodeURIComponent(legacyMatch[1]);
                searchType = 'forUsername';
            } else {
                showError('ƒê·ªãnh d·∫°ng URL kh√¥ng h·ª£p l·ªá. H√£y th·ª≠ /channel/UC..., @handle, ho·∫∑c /c/...');
                hideStatus();
                return null;
            }

            showStatus('ƒêang ph√¢n gi·∫£i URL t√πy ch·ªânh...');
            const apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=id&${searchType}=${searchTerm}&key=${API_KEY}`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.items && data.items.length > 0) return data.items[0].id;
                else {
                    showError(`Kh√¥ng t√¨m th·∫•y k√™nh v·ªõi t√™n: @${searchTerm}`);
                    hideStatus();
                    return null;
                }
            } catch (error) {
                console.error('L·ªói t√¨m Channel ID:', error);
                showError('L·ªói khi g·ªçi API ƒë·ªÉ t√¨m Channel ID.');
                hideStatus();
                return null;
            }
        }

        async function getVideosFromPlaylist(playlistId) {
            let allVideos = [];
            let nextPageToken = null;
            let page = 1;

            try {
                do {
                    statusText.textContent = `ƒêang t·∫£i trang video th·ª© ${page}... (T·ªïng: ${allVideos.length} video)`;
                    const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${playlistId}&maxResults=50${nextPageToken ? '&pageToken=' + nextPageToken : ''}&key=${API_KEY}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        if (response.status === 403) throw new Error('ƒê√£ h·∫øt h·∫°n ng·∫°ch (quota) API.');
                        throw new Error(`L·ªói API: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (data.items) allVideos = allVideos.concat(data.items);
                    nextPageToken = data.nextPageToken;
                    page++;
                } while (nextPageToken);
                return allVideos;
            } catch (error) {
                console.error('L·ªói khi l·∫•y video t·ª´ playlist:', error);
                showError(`L·ªói khi t·∫£i danh s√°ch video: ${error.message}`);
                return allVideos;
            }
        }

        async function getVideoDetails(playlistItems) {
            const detailsMap = new Map();
            const videoIds = playlistItems.map(item => item.snippet.resourceId.videoId);
            
            for (let i = 0; i < videoIds.length; i += 50) {
                const idBatch = videoIds.slice(i, i + 50);
                const idsString = idBatch.join(',');
                const url = `https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet,contentDetails&id=${idsString}&key=${API_KEY}`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        if (response.status === 403) throw new Error('ƒê√£ h·∫øt h·∫°n ng·∫°ch (quota) API khi l·∫•y chi ti·∫øt video.');
                        continue;
                    }
                    
                    const data = await response.json();
                    if (data.items) {
                        data.items.forEach(video => {
                            const stats = video.statistics || {};
                            const snippet = video.snippet || {};
                            const contentDetails = video.contentDetails || {}; 
                            detailsMap.set(video.id, {
                                viewCount: stats.viewCount || 0,
                                tags: snippet.tags || [],
                                duration: contentDetails.duration || 'PT0S',
                                liveBroadcastContent: snippet.liveBroadcastContent || 'none'
                            });
                        });
                    }
                } catch (error) {
                    console.error('L·ªói khi l·∫•y chi ti·∫øt video (batch):', error);
                    showError(error.message);
                }
            }
            return detailsMap;
        }

        function populateFilters(videos) {
            const total = videos.length;
            const yearCounts = {};
            const typeCounts = { long: 0, short: 0, live: 0 };

            videos.forEach(video => {
                const year = new Date(video.snippet.publishedAt).getFullYear();
                yearCounts[year] = (yearCounts[year] || 0) + 1;
                if (video.videoType) typeCounts[video.videoType]++;
            });

            const sortedYears = Object.keys(yearCounts).sort((a, b) => b - a);
            while (yearFilter.options.length > 1) yearFilter.remove(1);
            yearFilter.options[0].textContent = `T·∫•t c·∫£ nƒÉm (${total})`;
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year} (${yearCounts[year]})`;
                yearFilter.appendChild(option);
            });
            
            videoTypeFilter.options[0].textContent = `T·∫•t c·∫£ (${total})`;
            videoTypeFilter.options[1].textContent = `Video d√†i (${typeCounts.long})`;
            videoTypeFilter.options[2].textContent = `Video ng·∫Øn (${typeCounts.short})`;
            videoTypeFilter.options[3].textContent = `Ph√°t tr·ª±c ti·∫øp (${typeCounts.live})`;
        }

        function renderFilteredVideos() {
            const year = parseInt(yearFilter.value, 10);
            const topN = parseInt(viewsFilter.value, 10);
            const videoType = videoTypeFilter.value;
            
            let videosToDisplay = [...allFetchedVideos];

            if (year !== 0) {
                videosToDisplay = videosToDisplay.filter(video => new Date(video.snippet.publishedAt).getFullYear() === year);
            }
            if (videoType !== 'all') {
                videosToDisplay = videosToDisplay.filter(v => v.videoType === videoType);
            }

            if (topN !== 0) {
                videosToDisplay.sort((a, b) => b.viewCount - a.viewCount);
                videosToDisplay = videosToDisplay.slice(0, topN);
            } else {
                 videosToDisplay.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));
            }

            displayVideos(videosToDisplay);
        }

        function displayVideos(videos) {
            resultsContainer.innerHTML = '';
            if (videos.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Kh√¥ng t√¨m th·∫•y video n√†o ph√π h·ª£p.</p>';
                return;
            }

            videos.forEach(video => {
                const videoId = video.snippet.resourceId.videoId;
                const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                const title = video.snippet.title;
                const thumbnailUrl = video.snippet.thumbnails.medium ? video.snippet.thumbnails.medium.url : 'https://placehold.co/320x180';
                
                // [S·ª¨A] S·ª≠ d·ª•ng h√†m ƒë·ªãnh d·∫°ng m·ªõi
                const formattedDate = formatFullDate(new Date(video.snippet.publishedAt));
                const formattedViews = video.viewCount.toLocaleString('vi-VN');
                
                const tags = video.tags || [];
                const tagsSlice = tags.slice(0, 5); 
                let tagsHtml = '';
                if (showKeywords && tags.length > 0) {
                    tagsHtml = `
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-600 mb-1">T·ª´ kh√≥a:</h4>
                            <div class="flex flex-wrap gap-1">
                                ${tagsSlice.map(tag => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                            </div>
                        </div>`;
                }
                
                let copyTagsButtonHtml = '';
                if (showKeywords && tags.length > 0) {
                    copyTagsButtonHtml = `
                        <button class="copy-tags-btn text-xs px-2.5 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" data-tags="${tags.join(', ')}">
                            Copy T·ª´ kh√≥a
                        </button>`;
                }

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-all duration-300 hover:shadow-xl';
                card.innerHTML = `
                    <div class="relative">
                        <img src="${thumbnailUrl}" alt="${title}" class="w-full h-40 object-cover" onerror="this.src='https://placehold.co/320x180'">
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-base font-semibold text-gray-800 leading-snug mb-2 h-16 overflow-hidden">
                            <a href="${videoUrl}" target="_blank" class="hover:text-blue-600 line-clamp-2">${title}</a>
                        </h3>
                        <div class="text-sm text-gray-500 mt-auto">
                            <p class="mb-1">Th·ªùi gian ƒëƒÉng: ${formattedDate}</p>
                            <p>L∆∞·ª£t xem: ${formattedViews}</p>
                        </div>
                        ${tagsHtml}
                        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                            <button class="copy-link-btn text-xs px-2.5 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" data-link="${videoUrl}">
                                Copy Link
                            </button>
                            ${copyTagsButtonHtml}
                        </div>
                    </div>`;
                resultsContainer.appendChild(card);
            });
        }
        
        function handleToggleKeywords() {
            showKeywords = !showKeywords;
            if (showKeywords) {
                toggleKeywordsButton.textContent = '·∫®n T·ª´ kh√≥a';
                toggleKeywordsButton.classList.replace('bg-green-600', 'bg-red-600');
            } else {
                toggleKeywordsButton.textContent = 'Hi·ªán T·ª´ kh√≥a';
                toggleKeywordsButton.classList.replace('bg-red-600', 'bg-green-600');
            }
            renderFilteredVideos(); // V·∫Ω l·∫°i video ƒë·ªÉ hi·ªán/·∫©n t·ª´ kh√≥a
        }
        
        // [M·ªöI] H√†m x·ª≠ l√Ω b·∫≠t/t·∫Øt khu v·ª±c ph√¢n t√≠ch
        function handleAnalysis() {
            if (analysisResults.classList.contains('hidden')) {
                analysisResults.classList.remove('hidden');
                analysisButton.textContent = '·∫®n Ph√¢n t√≠ch';
                analysisButton.classList.replace('bg-purple-600', 'bg-gray-500');
                runAnalysis(allFetchedVideos);
            } else {
                analysisResults.classList.add('hidden');
                analysisButton.textContent = 'üìä Ph√¢n t√≠ch K√™nh';
                analysisButton.classList.replace('bg-gray-500', 'bg-purple-600');
            }
        }

        /**
         * [N√ÇNG C·∫§P] H√†m ch√≠nh ch·∫°y ph√¢n t√≠ch v√† v·∫Ω bi·ªÉu ƒë·ªì
         */
        function runAnalysis(videos) {
            destroyCharts(); // X√≥a bi·ªÉu ƒë·ªì c≈©
            const totalVideos = videos.length;
            if (totalVideos === 0) return;

            // --- 1. Ph√¢n t√≠ch Gi·ªù c√¥ng chi·∫øu (Chi ti·∫øt 24 gi·ªù) ---
            const hourData = {};
            HOUR_LABELS.forEach(label => hourData[label] = 0); // Kh·ªüi t·∫°o 24 gi·ªù
            
            videos.forEach(video => {
                const hour = new Date(video.snippet.publishedAt).getHours();
                const label = HOUR_LABELS[hour]; // L·∫•y nh√£n "00:00 - 01:00"
                hourData[label]++;
            });

            // --- 2. Ph√¢n t√≠ch Th·ª© trong tu·∫ßn ---
            const dayOfWeekData = {};
            WEEKDAY_NAMES.forEach(label => dayOfWeekData[label] = 0); // Kh·ªüi t·∫°o 7 ng√†y
            
            videos.forEach(video => {
                const dayIndex = new Date(video.snippet.publishedAt).getDay();
                dayOfWeekData[WEEKDAY_NAMES[dayIndex]]++;
            });

            // --- 3. Ph√¢n t√≠ch Ng√†y trong th√°ng (Chi ti·∫øt 31 ng√†y) ---
            const dayOfMonthData = {};
            DAY_OF_MONTH_LABELS.forEach(label => dayOfMonthData[label] = 0); // Kh·ªüi t·∫°o 31 ng√†y

            videos.forEach(video => {
                const date = new Date(video.snippet.publishedAt).getDate(); // 1-31
                const label = `Ng√†y ${date}`;
                dayOfMonthData[label]++;
            });

            // --- V·∫Ω bi·ªÉu ƒë·ªì ---
            const hourMeaning = getAnalysisMeaning(hourData, totalVideos, 'khung gi·ªù');
            const hourRec = getAnalysisRecommendation(hourData, totalVideos, 'khung gi·ªù');
            createBarChart('chartHour', hourData, hourMeaning, hourRec, CHART_COLORS.blue);

            const dayOfWeekMeaning = getAnalysisMeaning(dayOfWeekData, totalVideos, 'ng√†y');
            const dayOfWeekRec = getAnalysisRecommendation(dayOfWeekData, totalVideos, 'ng√†y');
            createBarChart('chartDayOfWeek', dayOfWeekData, dayOfWeekMeaning, dayOfWeekRec, CHART_COLORS.green);

            const dayOfMonthMeaning = getAnalysisMeaning(dayOfMonthData, totalVideos, 'th·ªùi ƒëi·ªÉm');
            const dayOfMonthRec = getAnalysisRecommendation(dayOfMonthData, totalVideos, 'th·ªùi ƒëi·ªÉm');
            createBarChart('chartDayOfMonth', dayOfMonthData, dayOfMonthMeaning, dayOfMonthRec, CHART_COLORS.yellow);
        }

        /**
         * [M·ªöI] H√†m t·∫°o vƒÉn b·∫£n "√ù nghƒ©a" (T√¨m 1 gi√° tr·ªã cao nh·∫•t)
         */
        function getAnalysisMeaning(data, total, unit) {
            let maxKey = '';
            let maxVal = -1;
            
            for (const [key, value] of Object.entries(data)) {
                if (value > maxVal) {
                    maxVal = value;
                    maxKey = key;
                }
            }
            
            if (maxVal <= 0) return `<p>Kh√¥ng c√≥ d·ªØ li·ªáu cho m·ª•c n√†y.</p>`;
            
            const percentage = ((maxVal / total) * 100).toFixed(1);
            return `<p>Ph√¢n t√≠ch cho th·∫•y <strong>${maxKey}</strong> l√† ${unit} ƒëƒÉng video ph·ªï bi·∫øn nh·∫•t, v·ªõi <strong>${maxVal} video</strong> (chi·∫øm <strong>${percentage}%</strong>).</p>`;
        }

        /**
         * [M·ªöI] H√†m t·∫°o vƒÉn b·∫£n "ƒê·ªÅ xu·∫•t Top 3"
         */
        function getAnalysisRecommendation(data, total, unit) {
            const sortedData = Object.entries(data)
                .map(([key, value]) => ({ key, value }))
                .filter(item => item.value > 0) // Ch·ªâ l·∫•y c√°c m·ª•c c√≥ video
                .sort((a, b) => b.value - a.value); // S·∫Øp x·∫øp gi·∫£m d·∫ßn

            if (sortedData.length === 0) {
                return '<h4 class="font-semibold text-gray-800 mb-2">ƒê·ªÅ xu·∫•t Top 3:</h4><p class="text-sm">Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t n√†o.</p>';
            }

            const top3 = sortedData.slice(0, 3);

            let html = `<h4 class="font-semibold text-gray-800 mb-2">ƒê·ªÅ xu·∫•t Top 3 ${unit}:</h4>`;
            html += '<ul class="list-none space-y-1">';

            top3.forEach((item, index) => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                html += `
                    <li class="flex justify-between items-center text-sm">
                        <span class="truncate pr-2"><strong>${index + 1}. ${item.key}</strong></span>
                        <span class="font-medium flex-shrink-0">${item.value} (${percentage}%)</span>
                    </li>`;
            });

            html += '</ul>';
            return html;
        }

        /**
         * [N√ÇNG C·∫§P] H√†m chung ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì C·ªòT (Bar)
         */
        function createBarChart(canvasId, data, meaningText, recommendationText, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(data);
            const values = Object.values(data);

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë video',
                        data: values,
                        backgroundColor: color,
                        borderColor: color.replace('0.7', '1'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Cho ph√©p t√πy ch·ªânh chi·ªÅu cao
                    scales: {
                        x: {
                            ticks: {
                                display: false // ·∫®n nh√£n tr·ª•c X (v√¨ qu√° nhi·ªÅu)
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Ch·ªâ hi·ªÉn th·ªã s·ªë nguy√™n
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // ·∫®n ch√∫ th√≠ch (v√¨ ch·ªâ c√≥ 1 b·ªô d·ªØ li·ªáu)
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `S·ªë video: ${context.raw}`
                            }
                        }
                    }
                }
            });

            chartInstances[canvasId] = chart;

            // Hi·ªÉn th·ªã √Ω nghƒ©a
            const meaningEl = document.getElementById(canvasId + 'Meaning');
            if (meaningEl) meaningEl.innerHTML = meaningText;

            // [M·ªöI] Hi·ªÉn th·ªã ƒë·ªÅ xu·∫•t
            const recEl = document.getElementById(canvasId + 'Recommendation');
            if (recEl) recEl.innerHTML = recommendationText;
        }

        // === C√ÅC H√ÄM TI·ªÜN √çCH (Copy, Th√¥ng b√°o, D·ªçn d·∫πp) ===
        
        function handleCopyClick(event) {
            let textToCopy = null;
            if (event.target.classList.contains('copy-link-btn')) {
                textToCopy = event.target.dataset.link;
            }
            if (event.target.classList.contains('copy-tags-btn')) {
                textToCopy = event.target.dataset.tags;
            }
            
            if (textToCopy) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy).then(showCopySuccess)
                        .catch(err => copyFallback(textToCopy));
                } else {
                     copyFallback(textToCopy);
                }
            }
        }
        
        function copyFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                if (document.execCommand('copy')) showCopySuccess();
            } catch (err) {
                console.error('L·ªói khi sao ch√©p (Fallback):', err);
            }
            document.body.removeChild(textArea);
        }

        function showStatus(message) {
            statusText.textContent = message;
            statusContainer.classList.remove('hidden');
        }

        function hideStatus() {
            statusContainer.classList.add('hidden');
        }

        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function clearError() {
            errorContainer.classList.add('hidden');
            errorContainer.textContent = '';
        }
        
        function showCopySuccess() {
            if (copyTimeout) clearTimeout(copyTimeout);
            copySuccessMessage.classList.remove('hidden', 'opacity-0');
            copyTimeout = setTimeout(() => {
                copySuccessMessage.classList.add('opacity-0');
                // Th√™m m·ªôt ch√∫t delay tr∆∞·ªõc khi ·∫©n h·∫≥n ƒë·ªÉ transition k·ªãp ch·∫°y
                setTimeout(() => copySuccessMessage.classList.add('hidden'), 300); 
            }, 2000);
        }

        function destroyCharts() {
            for (const id in chartInstances) {
                if (chartInstances[id]) {
                    chartInstances[id].destroy();
                    delete chartInstances[id];
                }
            }
        }

        function clearResults() {
            resultsContainer.innerHTML = '';
            clearError();
            
            // ·∫®n v√† Reset b·ªô l·ªçc
            filterContainerWrapper.classList.add('hidden');
            analysisButtonContainer.classList.add('hidden');
            analysisResults.classList.add('hidden');
            analysisButton.textContent = 'üìä Ph√¢n t√≠ch K√™nh';
            analysisButton.classList.replace('bg-gray-500', 'bg-purple-600');
            
            destroyCharts();

            // Reset c√°c b·ªô l·ªçc
            while (yearFilter.options.length > 1) yearFilter.remove(1);
            yearFilter.value = "0";
            yearFilter.options[0].textContent = 'T·∫•t c·∫£ nƒÉm';
            viewsFilter.value = "0";
            videoTypeFilter.value = 'all';
            videoTypeFilter.options[0].textContent = 'T·∫•t c·∫£';
            videoTypeFilter.options[1].textContent = 'Video d√†i';
            videoTypeFilter.options[2].textContent = 'Video ng·∫Øn';
            videoTypeFilter.options[3].textContent = 'Ph√°t tr·ª±c ti·∫øp';
            
            // Reset n√∫t t·ª´ kh√≥a
            showKeywords = false;
            toggleKeywordsButton.textContent = 'Hi·ªán T·ª´ kh√≥a';
            toggleKeywordsButton.classList.replace('bg-red-600', 'bg-green-600');

            allFetchedVideos = [];
        }

    </script>

</body>
</html>
