<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªô C√¥ng C·ª• YouTube - No1Ideas</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh font ch·ªØ Inter */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* --- CSS CHO TRANG CH·ª¶ (HUB) --- */
        .hub-container {
            display: flex; /* M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã trang ch·ªß */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }
        .tool-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            padding: 24px;
            width: 320px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .tool-card-icon { font-size: 48px; line-height: 1; }
        .tool-card h2 { font-size: 1.25rem; font-weight: 700; margin-top: 16px; color: #1e40af; } /* text-blue-800 */
        .tool-card p { font-size: 0.875rem; color: #4b5563; } /* text-gray-600 */

        /* --- CSS CHO C√ÅC C√îNG C·ª§ (·∫®N) --- */
        .tool-page {
            display: none; /* ·∫®n c√°c c√¥ng c·ª• ban ƒë·∫ßu */
        }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .back-to-hub {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: #3b82f6; /* text-blue-500 */
            cursor: pointer;
            text-decoration: none;
        }
        .back-to-hub:hover { text-decoration: underline; }
        
        /* --- CSS CHO C√îNG C·ª§ T·ª™ KHO√Å (L·∫•y t·ª´ code c≈©) --- */
        #keyword-tool { /* CSS c≈© c·ªßa b·∫°n */ }
        #keyword-tool ::-webkit-scrollbar { width: 6px; }
        #keyword-tool ::-webkit-scrollbar-track { background: #f1f1f1; }
        #keyword-tool ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #keyword-tool .popover {
            display: none; position: absolute; z-index: 50; width: 320px; 
            max-height: 400px; overflow-y: auto; word-wrap: break-word;
        }
        #keyword-tool .result-btn:hover + .popover,
        #keyword-tool .popover:hover { display: block; }
        #keyword-tool .toggle-desc { color: #2563eb; font-weight: 500; cursor: pointer; margin-left: 4px; }
        #keyword-tool .toggle-desc:hover { text-decoration: underline; }
        #keyword-tool .desc-full { display: none; }
        #keyword-tool .copy-btn {
            background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; 
            padding: 2px 8px; border-radius: 6px; font-size: 0.875rem; 
            font-weight: 500; transition: all 0.2s; cursor: pointer; flex-shrink: 0;
        }
        #keyword-tool .copy-btn:hover { background-color: #e5e7eb; }
        #keyword-tool .copy-btn:disabled { background-color: #d1fae5; color: #065f46; cursor: not-allowed; }
        #keyword-tool .copy-btn-popover { padding: 1px 6px; font-size: 0.75rem; }
        #keyword-tool .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CSS CHO C√îNG C·ª§ COMMENT (L·∫•y t·ª´ code m·ªõi) --- */
        #comment-tool {
            --red:#d32f2f; --bg:#f6f7fb; --muted:#666; --card:#fafafa; --border:#e9e9ef;
            background:#fff; padding:24px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.06)
        }
        #comment-tool .row{ display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap }
        #comment-tool .row .field{ flex:1; min-width:260px }
        #comment-tool input[type="text"]{
            width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:15px; outline:none;
        }
        #comment-tool button{ padding:12px 18px; font-size:15px; background:#ff0000; color:#fff; border:none;
            border-radius:10px; cursor:pointer; transition:.2s }
        #comment-tool button:hover{ background:#c00000 }
        #comment-tool button:disabled{ background:#cfcfcf; cursor:not-allowed }
        #comment-tool .hint{ font-size:12px; color:#888 }
        #comment-tool .sort-bar{ display:none; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 6px }
        #comment-tool .sort-title{ font-weight:700; color:#444 }
        #comment-tool .sort-btn{ border:1px solid #e5e7eb; background:#fff; color:#333; padding:8px 12px;
            border-radius:10px; cursor:pointer; font-size:14px }
        #comment-tool .sort-btn.active{ border-color:var(--red); color:var(--red); font-weight:800 }
        #comment-tool .sort-hint{ margin-left:auto; color:#888; font-size:12px }
        #comment-tool #status-comment{ text-align:center; font-size:14px; color:#777; margin:8px 0 0 }
        #comment-tool #results-comment{ margin-top:4px }
        #comment-tool .comment-thread{ border-bottom:1px solid var(--border); padding:16px 0 }
        #comment-tool .comment-thread:last-child{ border-bottom:none }
        #comment-tool .thread-row{ display:grid; grid-template-columns: 1fr 300px; gap:16px; align-items:start }
        @media (max-width: 980px){ #comment-tool .thread-row{ grid-template-columns:1fr } }
        #comment-tool .left-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
        @media (max-width: 720px){ #comment-tool .left-grid{ grid-template-columns:1fr } }
        #comment-tool .left-col{ border:1px solid var(--border); border-radius:12px; background:var(--card); padding:12px }
        #comment-tool .left-col h3{ margin:0 0 10px; font-size:14px; color:#555; font-weight:800 }
        #comment-tool .comment{ display:flex; align-items:flex-start; gap:12px }
        #comment-tool .comment + .comment{ margin-top:10px }
        #comment-tool .comment-author-img{ width:40px; height:40px; border-radius:50% }
        #comment-tool .comment-content{ flex:1 }
        #comment-tool .comment-author{ font-weight:800; margin-bottom:5px }
        #comment-tool .replies-container{ margin-left:52px; margin-top:12px; border-left:2px solid #e0e0e0; padding-left:12px }
        #comment-tool .reply .comment-author-img{ width:30px; height:30px }
        #comment-tool .reply{ margin-top:8px }
        #comment-tool .thread-right{ border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card) }
        #comment-tool .metrics-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
        #comment-tool .metric{ text-align:center; padding:10px 8px; border-radius:10px; background:#fff; border:1px solid #f0f0f0 }
        #comment-tool .metric-label{ font-size:12px; color:var(--muted); margin-bottom:4px }
        #comment-tool .metric-value{ font-weight:800; font-size:16px; word-break:break-word }
        #comment-tool .loader-comment {
            width: 20px; height: 20px; border-radius: 50%;
            border: 3px solid #f3f3f3; border-top: 3px solid #ff0000;
            animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle;
        }
    </style>
</head>
<body>

    <!-- TRANG CH·ª¶ (HUB) -->
    <div id="hub-page" class="hub-container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">B·ªô C√¥ng C·ª• YouTube</h1>
        <div class="flex flex-wrap justify-center gap-6">
            
            <!-- Card 1: C√¥ng c·ª• T·ª´ Kho√° -->
            <div id="card-keyword" class="tool-card">
                <div class="tool-card-icon">üîë</div>
                <h2>C√¥ng C·ª• T·ª´ Kho√°</h2>
                <p>Ph√¢n t√≠ch video & t·∫°o b·ªô t·ª´ kho√° SEO</p>
            </div>
            
            <!-- Card 2: C√¥ng c·ª• Comment -->
            <div id="card-comment" class="tool-card">
                <div class="tool-card-icon">üìù</div>
                <h2>Tr√¨nh L·∫•y Comment</h2>
                <p>T·∫£i, d·ªãch, v√† s·∫Øp x·∫øp b√¨nh lu·∫≠n video</p>
            </div>

        </div>
    </div>

    <!-- C√îNG C·ª§ 1: T·ª™ KHO√Å (·∫®N) -->
    <div id="keyword-tool" class="tool-page container mx-auto p-4 max-w-7xl">
        <div class="page-header">
            <h1 class="text-3xl font-bold text-center text-blue-600">C√¥ng C·ª• Ph√¢n T√≠ch YouTube & T·∫°o T·ª´ Kho√° Ch·ªß ƒê·ªÅ</h1>
            <a href="#" class="back-to-hub">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                Quay l·∫°i
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- C·ªòT B√äN TR√ÅI -->
            <div class="bg-white p-5 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Danh S√°ch Link YouTube (T·ªëi ƒëa 15)</h2>
                <div id="video-inputs" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                <button id="search-button-keyword" class="mt-5 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    <span>T√¨m ki·∫øm Th√¥ng Tin Video</span>
                </button>
            </div>
            <!-- C·ªòT B√äN PH·∫¢I -->
            <div class="bg-white p-5 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">T·∫°o D·ªØ Li·ªáu SEO cho Ch·ªß ƒê·ªÅ</h2>
                <button id="generate-keywords-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 2.25c.106 0 .21.02.313.06a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0114.25 6c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0119.5 9c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0124 12c0 .39-.05.77-.143 1.135a3 3 0 01-1.188 2.049c-.228.17-.478.322-.744.46a6.7 6.7 0 01-1.135 1.135a3 3 0 01-2.049 1.188c-.228.17-.478.322-.744.46A6.7 6.7 0 0118 19.5c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17-.228-.322-.478-.46-.744A6.7 6.7 0 0112 16.5c-.39 0-.77.05-1.135.143a3 3 0 01-2.049 1.188c-.17.228-.322.478-.46.744A6.7 6.7 0 017.5 19.5c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17.228-.322.478-.46.744A6.7 6.7 0 013 21c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17-.228-.322.478-.46-.744A6.7 6.7 0 010 18c0-.39.05-.77.143-1.135a3 3 0 011.188-2.049c.228-.17.478-.322.744-.46A6.7 6.7 0 013.75 12c0-.39.05-.77.143-1.135a3 3 0 011.188-2.049c.228-.17.478-.322.744-.46A6.7 6.7 0 017.5 6c.39 0 .77.05 1.135.143a3 3 0 012.049-1.188c.17-.228.322.478.46-.744A6.7 6.7 0 0112 3c.39 0 .77.05 1.135.143a3 3 0 012.049-1.188c.17-.228.322.478.46-.744A6.7 6.7 0 0116.5 0c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.103.04.207.06.313.06zM12 15a3 3 0 100-6 3 3 0 000 6z" /></svg>
                    <span>T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ</span>
                </button>
                <div id="keyword-results" class="mt-5 space-y-4 max-h-[550px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center">K·∫øt qu·∫£ t·∫°o t·ª´ kho√° s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- C√îNG C·ª§ 2: COMMENT (·∫®N) -->
    <div id="comment-tool" class="tool-page container mx-auto p-4 max-w-7xl">
        <div class="page-header">
            <h1 class="text-3xl font-bold text-center text-red-600">Tr√¨nh L·∫•y Comment YouTube</h1>
            <a href="#" class="back-to-hub">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                Quay l·∫°i
            </a>
        </div>
        <!-- H√†ng nh·∫≠p URL video -->
        <div class="row">
            <div class="field"><input id="video-url-comment" type="text" placeholder="D√°n link video YouTube v√†o ƒë√¢y..."></div>
            <button id="search-button-comment">T√¨m ki·∫øm</button>
        </div>
        
        <!-- Thanh s·∫Øp x·∫øp -->
        <div class="sort-bar" id="sort-bar-comment">
            <span class="sort-title">S·∫Øp x·∫øp theo:</span>
            <button class="sort-btn" id="sort-like">Like ‚Üì</button>
            <button class="sort-btn" id="sort-replies">Cmt c·∫•p 2 ‚Üì</button>
            <button class="sort-btn" id="sort-date">Ng√†y ‚Üì</button>
            <span class="sort-hint">B·∫•m l·∫°i n√∫t ƒë·ªÉ ƒë·∫£o chi·ªÅu ‚Üë/‚Üì</span>
        </div>

        <div id="status-comment"></div>
        <div id="results-comment"></div>
    </div>


    <!-- ================= SCRIPT CH√çNH ================= -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- LOGIC CHUY·ªÇN TRANG (HUB) ---
            const hubPage = document.getElementById('hub-page');
            const keywordToolPage = document.getElementById('keyword-tool');
            const commentToolPage = document.getElementById('comment-tool');
            
            const cardKeyword = document.getElementById('card-keyword');
            const cardComment = document.getElementById('card-comment');
            const backButtons = document.querySelectorAll('.back-to-hub');

            function showPage(pageToShow) {
                // ·∫®n t·∫•t c·∫£
                hubPage.style.display = 'none';
                keywordToolPage.style.display = 'none';
                commentToolPage.style.display = 'none';
                // Hi·ªÉn th·ªã trang ƒë∆∞·ª£c ch·ªçn
                pageToShow.style.display = 'block';
            }

            cardKeyword.addEventListener('click', () => showPage(keywordToolPage));
            cardComment.addEventListener('click', () => showPage(commentToolPage));
            backButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(hubPage);
                });
            });

            // --- B·∫ÆT ƒê·∫¶U: SCRIPT C√îNG C·ª§ 1 (T·ª™ KHO√Å) ---
            const videoInputsContainer = document.getElementById('video-inputs');
            const searchButtonKeyword = document.getElementById('search-button-keyword');
            const generateKeywordsButton = document.getElementById('generate-keywords-button');
            const keywordResultsContainer = document.getElementById('keyword-results');

            const NUM_INPUTS = 15;
            let videoDataStore = new Array(NUM_INPUTS).fill(null);

            function createInputRows() {
                for (let i = 0; i < NUM_INPUTS; i++) {
                    const row = document.createElement('div');
                    row.className = 'flex items-center space-x-2 relative';
                    row.innerHTML = `
                        <span class="font-semibold text-gray-500 w-6 text-right">${i + 1}.</span>
                        <input type="text" data-index="${i}" class="video-url-input flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="D√°n link YouTube...">
                        <button data-index="${i}" class="info-btn w-28 bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition duration-300 hover:bg-gray-400">
                            Th√¥ng tin
                        </button>
                        <div class="popover bg-white border border-gray-300 rounded-lg shadow-xl p-4 right-0 top-10">
                            <p class="popover-placeholder text-gray-600">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "T√¨m ki·∫øm".</p>
                            <div class="popover-content hidden space-y-3">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="font-bold text-base text-gray-900 popover-title flex-1 break-words"></h4>
                                        <button class="copy-btn copy-btn-popover ml-2" data-copy-type="title">Copy</button>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">M√¥ t·∫£:</h5>
                                        <button class="copy-btn copy-btn-popover" data-copy-type="desc">Copy</button>
                                    </div>
                                    <p class="text-sm text-gray-700 popover-description">
                                        <span class="desc-short"></span>
                                        <span class="desc-full"></span>
                                        <button class="toggle-desc hidden">Xem th√™m</button>
                                    </p>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">T·ª´ kho√°:</h5>
                                        <button class="copy-btn copy-btn-popover" data-copy-type="tags">Copy</button>
                                    </div>
                                    <div class="flex flex-wrap gap-1 popover-tags"></div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">Hashtags:</h5>
                                        <button class="copy-btn copy-btn-popover" data-copy-type="hashtags">Copy</button>
                                    </div>
                                    <div class="flex flex-wrap gap-1 popover-hashtags"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    videoInputsContainer.appendChild(row);
                }
            }

            searchButtonKeyword.addEventListener('click', async () => {
                setLoading(searchButtonKeyword, true, "ƒêang t√¨m ki·∫øm...");
                const inputs = document.querySelectorAll('.video-url-input');
                const infoButtons = document.querySelectorAll('.info-btn');
                const popovers = document.querySelectorAll('.popover');
                
                videoDataStore = new Array(NUM_INPUTS).fill(null);
                let fetchPromises = [];

                infoButtons.forEach((button, index) => {
                    updateInfoButton(button, null);
                    updatePopover(popovers[index], null);
                });

                inputs.forEach((input, index) => {
                    const url = input.value.trim();
                    const videoId = getYoutubeId(url);
                    const button = infoButtons[index];
                    const popover = popovers[index];
                    
                    if (videoId) {
                        fetchPromises.push(
                            fetchYouTubeVideoInfo(videoId)
                                .then(data => {
                                    videoDataStore[index] = data;
                                    updatePopover(popover, data);
                                    updateInfoButton(button, true);
                                })
                                .catch(error => {
                                    const errorData = { error: 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu' };
                                    videoDataStore[index] = errorData;
                                    updatePopover(popover, errorData);
                                    updateInfoButton(button, false);
                                })
                        );
                    } else if (url !== "") { 
                        const errorData = { error: 'Link kh√¥ng h·ª£p l·ªá' };
                        videoDataStore[index] = errorData;
                        updatePopover(popover, errorData);
                        updateInfoButton(button, false);
                    }
                });

                await Promise.allSettled(fetchPromises);
                setLoading(searchButtonKeyword, false, "T√¨m ki·∫øm Th√¥ng Tin Video");
            });

            generateKeywordsButton.addEventListener('click', async () => {
                setLoading(generateKeywordsButton, true, "ƒêang t·∫°o...");
                keywordResultsContainer.innerHTML = '<div class="flex justify-center items-center p-10"><div class="loader"></div><span class="ml-3">ƒêang li√™n h·ªá v·ªõi Gemini...</span></div>';

                let combinedText = "";
                videoDataStore.forEach(data => {
                    if (data && !data.error) {
                        combinedText += `Ti√™u ƒë·ªÅ: ${data.title}\n`;
                        combinedText += `M√¥ t·∫£: ${data.description}\n`;
                        if (data.tags && data.tags.length > 0) {
                            combinedText += `Tags: ${data.tags.join(', ')}\n`;
                        }
                        combinedText += "---\n";
                    }
                });

                if (combinedText.trim() === "") {
                    keywordResultsContainer.innerHTML = '<p class="text-red-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu video ƒë·ªÉ ph√¢n t√≠ch. Vui l√≤ng "T√¨m ki·∫øm" video tr∆∞·ªõc.</p>';
                    setLoading(generateKeywordsButton, false, "T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ");
                    return;
                }

                try {
                    const result = await callGeminiApi(combinedText);
                    displayKeywordResults(result);
                } catch (error) {
                    console.error("L·ªói khi g·ªçi Gemini API:", error);
                    keywordResultsContainer.innerHTML = `<p class="text-red-500 text-center"><strong>ƒê√£ x·∫£y ra l·ªói:</strong> ${error.message}</p>`;
                } finally {
                    setLoading(generateKeywordsButton, false, "T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ");
                }
            });

            function getYoutubeId(url) {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            async function fetchYouTubeVideoInfo(videoId) {
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: videoId })
                });
                if (!response.ok) {
                    let errorMessage = `L·ªói m√°y ch·ªß: ${response.status}`;
                    try { const errorData = await response.json(); errorMessage = errorData.message || JSON.stringify(errorData); }
                    catch (e) { errorMessage = await response.text(); }
                    throw new Error(errorMessage);
                }
                return response.json();
            }

            function updateInfoButton(buttonElement, isSuccess) {
                buttonElement.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'bg-indigo-500', 'text-white', 'hover:bg-indigo-600', 'result-btn', 'bg-red-500', 'hover:bg-red-600');
                if (isSuccess === true) {
                    buttonElement.textContent = 'K·∫øt qu·∫£';
                    buttonElement.classList.add('bg-indigo-500', 'text-white', 'hover:bg-indigo-600', 'result-btn');
                } else if (isSuccess === false) {
                    buttonElement.textContent = 'L·ªói';
                    buttonElement.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                } else {
                    buttonElement.textContent = 'Th√¥ng tin';
                    buttonElement.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                }
            }

            function updatePopover(popoverElement, data) {
                const placeholder = popoverElement.querySelector('.popover-placeholder');
                const contentDiv = popoverElement.querySelector('.popover-content');
                if (data && !data.error) {
                    placeholder.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                    const { title, description, tags } = data;
                    contentDiv.querySelector('.popover-title').textContent = title;
                    const descP = contentDiv.querySelector('.popover-description');
                    const descShort = descP.querySelector('.desc-short');
                    const descFull = descP.querySelector('.desc-full');
                    const toggleBtn = descP.querySelector('.toggle-desc');
                    if (description.length > 120) {
                        descShort.textContent = description.substring(0, 120) + '...';
                        descFull.textContent = description;
                        toggleBtn.classList.remove('hidden');
                        descFull.style.display = 'none';
                        toggleBtn.textContent = 'Xem th√™m';
                        toggleBtn.onclick = () => {
                            const isHidden = descFull.style.display === 'none';
                            descFull.style.display = isHidden ? 'inline' : 'none';
                            toggleBtn.textContent = isHidden ? 'Thu g·ªçn' : 'Xem th√™m';
                        };
                    } else {
                        descShort.textContent = description;
                        descFull.textContent = '';
                        toggleBtn.classList.add('hidden');
                    }
                    const tagsContainer = contentDiv.querySelector('.popover-tags');
                    tagsContainer.innerHTML = '';
                    if (tags.length > 0) {
                        tags.forEach(tag => {
                            const tagEl = document.createElement('span');
                            tagEl.className = 'bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs';
                            tagEl.textContent = tag;
                            tagsContainer.appendChild(tagEl);
                        });
                    } else {
                        tagsContainer.innerHTML = '<i class="text-gray-500 text-xs">Kh√¥ng c√≥ tags</i>';
                    }
                    const hashtagsContainer = contentDiv.querySelector('.popover-hashtags');
                    hashtagsContainer.innerHTML = '';
                    const hashtagRegex = /#[\w\d]+/g;
                    const foundHashtags = description.match(hashtagRegex) || [];
                    if (foundHashtags.length > 0) {
                        foundHashtags.forEach(tag => {
                            const tagEl = document.createElement('span');
                            tagEl.className = 'bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs';
                            tagEl.textContent = tag;
                            hashtagsContainer.appendChild(tagEl);
                        });
                    } else {
                        hashtagsContainer.innerHTML = '<i class="text-gray-500 text-xs">Kh√¥ng c√≥ hashtags</i>';
                    }
                    const copyTitleBtn = contentDiv.querySelector('[data-copy-type="title"]');
                    const copyDescBtn = contentDiv.querySelector('[data-copy-type="desc"]');
                    const copyTagsBtn = contentDiv.querySelector('[data-copy-type="tags"]');
                    const copyHashtagsBtn = contentDiv.querySelector('[data-copy-type="hashtags"]');
                    copyTitleBtn.onclick = () => copyToClipboard(title, copyTitleBtn);
                    copyDescBtn.onclick = () => copyToClipboard(description, copyDescBtn);
                    copyTagsBtn.onclick = () => copyToClipboard(tags.join(', '), copyTagsBtn);
                    copyHashtagsBtn.onclick = () => copyToClipboard(foundHashtags.join(' '), copyHashtagsBtn);
                } else {
                    placeholder.classList.remove('hidden');
                    contentDiv.classList.add('hidden');
                    if (data && data.error) {
                        placeholder.textContent = data.error;
                        placeholder.classList.add('text-red-500');
                    } else {
                        placeholder.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "T√¨m ki·∫øm".';
                        placeholder.classList.remove('text-red-500');
                    }
                }
            }

            function setLoading(button, isLoading, loadingText) {
                if (!button.dataset.originalContent) {
                    button.dataset.originalContent = button.innerHTML;
                }
                const originalContent = button.dataset.originalContent;
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = `<div class="loader"></div><span>${loadingText}</span>`;
                } else {
                    button.disabled = false;
                    button.innerHTML = originalContent.replace(/<span>(.*?)<\/span>/, `<span>${loadingText}</span>`);
                }
            }

            async function callGeminiApi(promptText) {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText })
                });
                if (!response.ok) {
                    let errorMessage = `L·ªói m√°y ch·ªß: ${response.status}`;
                    try { const errorData = await response.json(); errorMessage = errorData.message || JSON.stringify(errorData); }
                    catch (e) { errorMessage = await response.text(); }
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                return result;
            }

            function displayKeywordResults(data) {
                keywordResultsContainer.innerHTML = '';
                const createSection = (title, content, copyText) => {
                    const section = document.createElement('div');
                    section.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center mb-3';
                    const titleEl = document.createElement('h3');
                    titleEl.className = 'text-lg font-semibold text-gray-800';
                    titleEl.textContent = title;
                    header.appendChild(titleEl);
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.dataset.copyText = copyText || '';
                    copyButton.addEventListener('click', () => {
                        copyToClipboard(copyButton.dataset.copyText, copyButton);
                    });
                    header.appendChild(copyButton);
                    section.appendChild(header);
                    if (Array.isArray(content) && content.length > 0) {
                        const list = document.createElement('div');
                        list.className = 'flex flex-wrap gap-2';
                        content.forEach(item => {
                            const itemEl = document.createElement('span');
                            itemEl.className = 'bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full';
                            itemEl.textContent = item;
                            list.appendChild(itemEl);
                        });
                        section.appendChild(list);
                    } else if (typeof content === 'string' && content) {
                        const contentEl = document.createElement('p');
                        contentEl.className = 'text-gray-700 whitespace-pre-wrap';
                        contentEl.textContent = content;
                        section.appendChild(contentEl);
                    } else {
                        const contentEl = document.createElement('p');
                        contentEl.className = 'text-gray-500 italic';
                        contentEl.textContent = (content && content.length === 0) ? 'Kh√¥ng c√≥' : 'N/A';
                        section.appendChild(contentEl);
                    }
                    keywordResultsContainer.appendChild(section);
                };
                createSection('B·ªô T·ª´ Kho√° Ch√≠nh', data.boTuKhoaChinh, data.boTuKhoaChinh.join(', '));
                createSection('T·ª´ Kho√° B·ªï Tr·ª£', data.tuKhoaBoTro, data.tuKhoaBoTro.join(', '));
                createSection('T·ª´ Kho√° Li√™n Quan', data.tuKhoaLienQuan, data.tuKhoaLienQuan.join(', '));
                createSection('T·ª´ Kho√° Th∆∞∆°ng Hi·ªáu', data.tuKhoaThuongHieu, data.tuKhoaThuongHieu.join(', '));
                createSection('Hashtags', data.hashtags, data.hashtags.join(' '));
                createSection('Ti√™u ƒê·ªÅ Ch·ªß ƒê·ªÅ (Danh s√°ch ph√°t)', data.tieuDeChuDe, data.tieuDeChuDe);
                createSection('M√¥ T·∫£ Ch·ªß ƒê·ªÅ (Danh s√°ch ph√°t)', data.moTaChuDe, data.moTaChuDe);
            }

            function copyToClipboard(text, buttonElement) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed'; textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    buttonElement.textContent = 'ƒê√£ ch√©p!';
                    buttonElement.disabled = true;
                    setTimeout(() => {
                        buttonElement.textContent = 'Copy';
                        buttonElement.disabled = false;
                    }, 2000);
                } catch (err) {
                    console.error('Kh√¥ng th·ªÉ copy:', err);
                    buttonElement.textContent = 'L·ªói';
                }
                document.body.removeChild(textArea);
            }

            createInputRows();
            // --- K·∫æT TH√öC: SCRIPT C√îNG C·ª§ 1 (T·ª™ KHO√Å) ---


            // --- B·∫ÆT ƒê·∫¶U: SCRIPT C√îNG C·ª§ 2 (COMMENT) ---
            const btnSearchComment = document.getElementById('search-button-comment');
            const inputUrlComment = document.getElementById('video-url-comment');
            const divResultsComment = document.getElementById('results-comment');
            const divStatusComment = document.getElementById('status-comment');
            const divSortBarComment = document.getElementById('sort-bar-comment');
            const btnSortLike = document.getElementById('sort-like');
            const btnSortReplies = document.getElementById('sort-replies');
            const btnSortDate = document.getElementById('sort-date');

            let allThreads = [];
            let sortKey = 'date';
            let sortDir = 'desc';

            async function translateBatchToVi(texts) {
                if (!texts || !texts.length) return [];
                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texts: texts })
                    });
                    if (!response.ok) throw new Error('D·ªãch l·ªói (m√°y ch·ªß)');
                    const data = await response.json();
                    return data.translations || texts.map(() => '(D·ªãch l·ªói)');
                } catch (e) {
                    console.warn('Translate API call failed:', e);
                    return texts.map(() => '(D·ªãch l·ªói)');
                }
            }

            function attachSortHandlers() {
                function activate(btn) { [btnSortLike, btnSortReplies, btnSortDate].forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
                function toggleDir(btn, label) { sortDir = (sortDir === 'desc') ? 'asc' : 'desc'; btn.textContent = `${label} ${sortDir === 'desc' ? '‚Üì' : '‚Üë'}`; }

                btnSortLike.addEventListener('click', () => {
                    if (sortKey !== 'like') { sortKey = 'like'; sortDir = 'desc'; btnSortLike.textContent = 'Like ‚Üì'; }
                    else toggleDir(btnSortLike, 'Like');
                    activate(btnSortLike); renderThreads();
                });
                btnSortReplies.addEventListener('click', () => {
                    if (sortKey !== 'replies') { sortKey = 'replies'; sortDir = 'desc'; btnSortReplies.textContent = 'Cmt c·∫•p 2 ‚Üì'; }
                    else toggleDir(btnSortReplies, 'Cmt c·∫•p 2');
                    activate(btnSortReplies); renderThreads();
                });
                btnSortDate.addEventListener('click', () => {
                    if (sortKey !== 'date') { sortKey = 'date'; sortDir = 'desc'; btnSortDate.textContent = 'Ng√†y ‚Üì'; }
                    else toggleDir(btnSortDate, 'Ng√†y');
                    activate(btnSortDate); renderThreads();
                });
                btnSortDate.classList.add('active');
            }

            btnSearchComment.addEventListener('click', async () => {
                const videoURL = inputUrlComment.value.trim();
                if (!videoURL) { alert('Vui l√≤ng nh·∫≠p link video YouTube.'); return; }
                const videoId = getYoutubeId(videoURL); // D√πng l·∫°i h√†m getYoutubeId
                if (!videoId) { alert('Link video kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.'); return; }

                btnSearchComment.disabled = true;
                btnSearchComment.innerHTML = '<span class="loader-comment"></span>ƒêang t·∫£i...';
                divResultsComment.innerHTML = '';
                divStatusComment.textContent = 'ƒêang l·∫•y d·ªØ li·ªáu, vui l√≤ng ch·ªù...';
                allThreads = [];
                divSortBarComment.style.display = 'none';

                try {
                    await fetchAllComments(videoId);
                    if (allThreads.length) {
                        divStatusComment.textContent = `ƒê√£ t·∫£i xong ${allThreads.length} b√¨nh lu·∫≠n c·∫•p 1! ƒêang d·ªãch...`;
                        if (!btnSortLike.hasAttribute('data-inited')) {
                            attachSortHandlers(); btnSortLike.setAttribute('data-inited', '1');
                        }
                        divSortBarComment.style.display = 'flex';
                        await renderThreads(); // Ch·ªù d·ªãch v√† render
                        divStatusComment.textContent = `ƒê√£ t·∫£i v√† d·ªãch xong ${allThreads.length} b√¨nh lu·∫≠n.`;
                    } else {
                        divStatusComment.textContent = 'Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n n√†o ho·∫∑c video ƒë√£ t·∫Øt b√¨nh lu·∫≠n.';
                    }
                } catch (e) {
                    console.error('L·ªói:', e);
                    divStatusComment.textContent = `ƒê√£ x·∫£y ra l·ªói: ${e.message}`;
                } finally {
                    btnSearchComment.disabled = false;
                    btnSearchComment.textContent = 'T√¨m ki·∫øm';
                }
            });

            async function fetchAllComments(videoId, pageToken = '') {
                // G·ªçi backend /api/youtube-comments
                const response = await fetch('/api/youtube-comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: videoId, pageToken: pageToken })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ backend');
                
                if (data.items) collectThreads(data.items);
                if (data.nextPageToken) {
                    divStatusComment.textContent = `ƒê√£ t·∫£i ${allThreads.length} comments... ƒêang t·∫£i th√™m...`;
                    await fetchAllComments(videoId, data.nextPageToken);
                }
            }

            function collectThreads(items) {
                items.forEach(item => {
                    const top = item.snippet.topLevelComment?.snippet || {};
                    const likeCount = Number(top.likeCount || 0);
                    const totalReplies = Number(item.snippet.totalReplyCount || 0);
                    const publishedAtISO = top.publishedAt || null;
                    const publishedDate = publishedAtISO ? new Date(publishedAtISO) : null;
                    const originals = [];
                    originals.push(top.textOriginal || '');
                    (item.replies?.comments || []).forEach(r => originals.push(r.snippet?.textOriginal || ''));
                    allThreads.push({
                        raw: item,
                        likeCount, totalReplies,
                        publishedAtISO, publishedDate,
                        originals, translations: null
                    });
                });
            }

            async function renderThreads() {
                const arr = [...allThreads];
                arr.sort((a, b) => {
                    let va, vb;
                    if (sortKey === 'like') { va = a.likeCount; vb = b.likeCount; }
                    else if (sortKey === 'replies') { va = a.totalReplies; vb = b.totalReplies; }
                    else { va = a.publishedDate ? a.publishedDate.getTime() : 0; vb = b.publishedDate ? b.publishedDate.getTime() : 0; }
                    return (sortDir === 'desc') ? (vb - va) : (va - vb);
                });

                divResultsComment.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©
                
                // Ch·ªâ d·ªãch v√† render 50 c√°i ƒë·∫ßu ti√™n ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô
                // B·∫°n c√≥ th·ªÉ thay ƒë·ªïi logic n√†y (v√≠ d·ª•: lazy load)
                const itemsToRender = arr; // Render t·∫•t c·∫£
                let translatedCount = 0;

                for (const obj of itemsToRender) {
                    if (!obj.translations) {
                        try {
                            obj.translations = await translateBatchToVi(obj.originals);
                            translatedCount++;
                            if(translatedCount % 10 === 0) { // C·∫≠p nh·∫≠t status sau m·ªói 10 l∆∞·ª£t d·ªãch
                                divStatusComment.textContent = `ƒêang d·ªãch... (${translatedCount}/${itemsToRender.length})`;
                            }
                        }
                        catch (e) {
                            console.warn('D·ªãch l·ªói:', e);
                            obj.translations = obj.originals.map(() => '(Ch∆∞a d·ªãch)');
                        }
                    }
                    divResultsComment.appendChild(createThreadDOM(obj));
                }
                divStatusComment.textContent = `ƒê√£ hi·ªÉn th·ªã ${itemsToRender.length} b√¨nh lu·∫≠n.`;
            }

            function createThreadDOM(threadObj) {
                const { raw, likeCount, totalReplies, publishedAtISO, publishedDate, translations } = threadObj;
                const top = raw.snippet.topLevelComment.snippet;
                const threadDiv = document.createElement('div'); threadDiv.className = 'comment-thread';
                const rowDiv = document.createElement('div'); rowDiv.className = 'thread-row';
                const leftWrap = document.createElement('div'); leftWrap.className = 'left-grid';
                const colOriginal = document.createElement('div'); colOriginal.className = 'left-col';
                colOriginal.innerHTML = `<h3>Nguy√™n b·∫£n</h3>`;
                colOriginal.appendChild(createCommentElement(top, false, null, false));
                if (raw.replies) {
                    const rep = document.createElement('div'); rep.className = 'replies-container';
                    raw.replies.comments.forEach(r => rep.appendChild(createCommentElement(r.snippet, true, null, false)));
                    colOriginal.appendChild(rep);
                }
                const colTranslated = document.createElement('div'); colTranslated.className = 'left-col';
                colTranslated.innerHTML = `<h3>B·∫£n d·ªãch (vi)</h3>`;
                colTranslated.appendChild(createCommentElement(top, false, (translations?.[0] ?? '(Ch∆∞a d·ªãch)'), true));
                if (raw.replies) {
                    const repVi = document.createElement('div'); repVi.className = 'replies-container';
                    raw.replies.comments.forEach((r, idx) => repVi.appendChild(createCommentElement(r.snippet, true, (translations?.[idx + 1] ?? '(Ch∆∞a d·ªãch)'), true)));
                    colTranslated.appendChild(repVi);
                }
                leftWrap.appendChild(colOriginal);
                leftWrap.appendChild(colTranslated);
                const rightDiv = document.createElement('div'); rightDiv.className = 'thread-right';
                const metrics = document.createElement('div'); metrics.className = 'metrics-grid';
                const likeBox = document.createElement('div'); likeBox.className = 'metric';
                likeBox.innerHTML = `<div class="metric-label">Like (c·∫•p 1)</div><div class="metric-value">${likeCount.toLocaleString('vi-VN')}</div>`;
                const replyBox = document.createElement('div'); replyBox.className = 'metric';
                replyBox.innerHTML = `<div class="metric-label">Cmt c·∫•p 2</div><div class="metric-value">${totalReplies.toLocaleString('vi-VN')}</div>`;
                const dateBox = document.createElement('div'); dateBox.className = 'metric';
                const dateText = publishedDate ? publishedDate.toLocaleString('vi-VN', { hour12: false }) : '‚Äî';
                dateBox.innerHTML = `<div class="metric-label">Ng√†y</div><div class="metric-value" title="${publishedAtISO || ''}">${dateText}</div>`;
                metrics.appendChild(likeBox); metrics.appendChild(replyBox); metrics.appendChild(dateBox);
                rightDiv.appendChild(metrics);
                rowDiv.appendChild(leftWrap);
                rowDiv.appendChild(rightDiv);
                threadDiv.appendChild(rowDiv);
                return threadDiv;
            }

            function createCommentElement(snippet, isReply = false, overrideText = null, forcePlain = false) {
                const wrap = document.createElement('div'); wrap.className = isReply ? 'comment reply' : 'comment';
                const avatar = document.createElement('img');
                avatar.className = 'comment-author-img'; avatar.src = snippet.authorProfileImageUrl; avatar.alt = 'Avatar';
                const content = document.createElement('div'); content.className = 'comment-content';
                const author = document.createElement('div'); author.className = 'comment-author';
                author.textContent = snippet.authorDisplayName || '(Kh√¥ng r√µ)';
                const text = document.createElement('div');
                if (overrideText !== null) { text.textContent = overrideText; }
                else {
                    if (forcePlain) text.textContent = snippet.textOriginal || '';
                    else text.innerHTML = snippet.textDisplay || '';
                }
                content.appendChild(author); content.appendChild(text);
                wrap.appendChild(avatar); wrap.appendChild(content);
                return wrap;
            }
            // --- K·∫æT TH√öC: SCRIPT C√îNG C·ª§ 2 (COMMENT) ---

        }); // K·∫øt th√∫c DOMContentLoaded
    </script>
</body>
</html>

