<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªô C√¥ng C·ª• YouTube (T·ª´ Kho√° & Comment)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh font ch·ªØ Inter */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* ·∫®n/Hi·ªán c√°c trang */
        .page { display: none; }
        .page.active { display: block; }
        #page-hub { display: block; } /* Trang ch·ªß lu√¥n hi·ªÉn th·ªã ban ƒë·∫ßu */

        /* Trang ch·ªß (Hub) */
        .hub-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 2rem; /* 32px */
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .hub-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .hub-card h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #1d4ed8; /* text-blue-700 */
            margin-bottom: 0.75rem; /* 12px */
        }
        .hub-card p {
            font-size: 1rem; /* 16px */
            color: #4b5563; /* text-gray-600 */
        }

        /* N√∫t quay l·∫°i chung */
        .back-button {
            display: inline-flex;
            align-items: center;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            background-color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #d1d5db; /* border-gray-300 */
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }
        .back-button:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        
        /* --- CSS CHO C√îNG C·ª§ T·ª™ KH√ìA (T√°i s·ª≠ d·ª•ng) --- */
        .popover {
            display: none; position: absolute; z-index: 50; width: 320px;
            max-height: 400px; overflow-y: auto; word-wrap: break-word;
        }
        .result-btn:hover + .popover, .popover:hover { display: block; }
        .toggle-desc { color: #2563eb; font-weight: 500; cursor: pointer; margin-left: 4px; }
        .toggle-desc:hover { text-decoration: underline; }
        .desc-full { display: none; }
        .copy-btn {
            background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db;
            padding: 2px 8px; border-radius: 6px; font-size: 0.875rem; font-weight: 500;
            transition: all 0.2s; cursor: pointer; flex-shrink: 0;
        }
        .copy-btn:hover { background-color: #e5e7eb; }
        .copy-btn:disabled { background-color: #d1fae5; color: #065f46; cursor: not-allowed; }
        .popover-copy-btn {
            background-color: #e0e7ff; color: #3730a3; padding: 2px 6px;
            border-radius: 4px; font-size: 0.75rem; font-weight: 500;
            transition: all 0.2s; cursor: pointer;
        }
        .popover-copy-btn:hover { background-color: #c7d2fe; }
        .popover-copy-btn:disabled { background-color: #d1fae5; color: #065f46; cursor: not-allowed; }

        /* --- CSS CHO C√îNG C·ª§ COMMENT --- */
        .comment-tool-container { width:100%; max-width:1120px; background:#fff; padding:24px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.06) }
        .comment-tool-container h1 { margin:0 0 18px; text-align:center; color:#d32f2f; font-weight:800; }
        .comment-row { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap }
        .comment-row .field { flex:1; min-width:260px }
        .comment-input[type="text"] { width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:15px; outline:none; }
        .comment-btn { 
            padding:12px 18px; 
            font-size:15px; 
            background:#ff0000; 
            color:#fff; 
            border:none; 
            border-radius:10px; 
            cursor:pointer; 
            transition:.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .comment-btn:hover { background:#c00000 }
        .comment-btn:disabled { background:#cfcfcf; cursor:not-allowed }
        
        /* N√∫t ch·ªçn ng√¥n ng·ªØ M·ªöI */
        .lang-select-btn {
            padding: 12px 14px; font-size: 15px; background: #fff; color: #333;
            border: 1px solid #ddd; border-radius: 10px; cursor: pointer;
            transition: .2s; position: relative; white-space: nowrap;
        }
        .lang-select-btn:hover { background: #f9f9f9; }
        .lang-select-btn span { color: #1d4ed8; font-weight: 600; }
        .lang-dropdown {
            display: none; position: absolute; bottom: 100%; /* Hi·ªÉn th·ªã b√™n tr√™n n√∫t */
            left: 0; right: 0; background: #fff; border: 1px solid #ddd;
            border-radius: 10px; padding: 8px; max-height: 200px;
            overflow-y: auto; z-index: 10; box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }
        .lang-dropdown.show { display: block; }
        .lang-option {
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
        }
        .lang-option:hover { background-color: #f3f4f6; }
        .lang-option.selected { background-color: #dbeafe; color: #1d4ed8; font-weight: 600; }

        .sort-bar { display:none; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 6px }
        .sort-title { font-weight:700; color:#444 }
        .sort-btn { border:1px solid #e5e7eb; background:#fff; color:#333; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:14px }
        .sort-btn.active { border-color:#d32f2f; color:#d32f2f; font-weight:800 }
        .sort-hint { margin-left:auto; color:#888; font-size:12px }
        #comment-status { text-align:center; font-size:14px; color:#777; margin:8px 0 0 }
        #comment-results { margin-top:4px }
        .comment-thread { border-bottom:1px solid #e9e9ef; padding:16px 0 }
        .comment-thread:last-child { border-bottom:none }
        .thread-row { display:grid; grid-template-columns: 1fr 300px; gap:16px; align-items:start }
        .left-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px }
        .left-col { border:1px solid #e9e9ef; border-radius:12px; background:#fafafa; padding:12px }
        .left-col h3 { margin:0 0 10px; font-size:14px; color:#555; font-weight:800 }
        .comment { display:flex; align-items:flex-start; gap:12px }
        .comment + .comment { margin-top:10px }
        .comment-author-img { width:40px; height:40px; border-radius:50%; background-color: #eee; }
        .comment-content { flex:1 }
        .comment-author { font-weight:800; margin-bottom:5px }
        .replies-container { margin-left:52px; margin-top:12px; border-left:2px solid #e0e0e0; padding-left:12px }
        .reply .comment-author-img { width:30px; height:30px }
        .reply { margin-top:8px }
        .thread-right { border:1px solid #e9e9ef; border-radius:12px; padding:12px; background:#fafafa }
        .metrics-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
        .metric { text-align:center; padding:10px 8px; border-radius:10px; background:#fff; border:1px solid #f0f0f0 }
        .metric-label { font-size:12px; color:#666; margin-bottom:4px }
        .metric-value { font-weight:800; font-size:16px; word-break:break-word }
        @media (max-width: 980px){ .thread-row{ grid-template-columns:1fr } .thread-right { margin-top: 16px; } }
        @media (max-width: 720px){ .left-grid{ grid-template-columns:1fr } }

        /* Hi·ªáu ·ª©ng loading chung */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Trang ch·ªß (Hub) -->
    <div id="page-hub" class="page active container mx-auto p-4 max-w-4xl">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">B·ªô C√¥ng C·ª• YouTube</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Card 1: C√¥ng c·ª• T·ª´ kho√° -->
            <div id="hub-card-keywords" class="hub-card" data-page="page-keywords">
                <h2>üöÄ C√¥ng C·ª• T·ª´ Kho√° SEO</h2>
                <p>Ph√¢n t√≠ch video v√† t·∫°o b·ªô t·ª´ kho√°, ti√™u ƒë·ªÅ, m√¥ t·∫£ chu·∫©n SEO cho ch·ªß ƒë·ªÅ c·ªßa b·∫°n.</p>
            </div>
            <!-- Card 2: C√¥ng c·ª• Comment -->
            <div id="hub-card-comments" class="hub-card" data-page="page-comments">
                <h2>üìù Tr√¨nh L·∫•y Comment</h2>
                <p>L·∫•y to√†n b·ªô b√¨nh lu·∫≠n t·ª´ video, t·ª± ƒë·ªông d·ªãch v√† s·∫Øp x·∫øp theo l∆∞·ª£t th√≠ch.</p>
            </div>
        </div>
    </div>

    <!-- Trang 1: C√¥ng C·ª• Ph√¢n T√≠ch YouTube & T·∫°o T·ª´ Kho√° (·∫®n) -->
    <div id="page-keywords" class="page container mx-auto p-4 max-w-7xl">
        <button class="back-button" data-page="page-hub">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Quay l·∫°i
        </button>
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">C√¥ng C·ª• Ph√¢n T√≠ch YouTube & T·∫°o T·ª´ Kho√° Ch·ªß ƒê·ªÅ</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- C·ªòT B√äN TR√ÅI -->
            <div class="bg-white p-5 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Danh S√°ch Link YouTube (T·ªëi ƒëa 15)</h2>
                <div id="keywords-video-inputs" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                    <!-- 15 h√†ng s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
                </div>
                <button id="keywords-search-button" class="mt-5 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    <span>T√¨m ki·∫øm Th√¥ng Tin Video</span>
                </button>
            </div>
            <!-- C·ªòT B√äN PH·∫¢I -->
            <div class="bg-white p-5 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">T·∫°o D·ªØ Li·ªáu SEO cho Ch·ªß ƒê·ªÅ</h2>
                <button id="keywords-generate-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 2.25c.106 0 .21.02.313.06a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0114.25 6c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0119.5 9c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.17.228.322.478.46.744A6.7 6.7 0 0124 12c0 .39-.05.77-.143 1.135a3 3 0 01-1.188 2.049c-.228.17-.478.322-.744.46a6.7 6.7 0 01-1.135 1.135a3 3 0 01-2.049 1.188c-.228.17-.478.322-.744.46A6.7 6.7 0 0118 19.5c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17-.228-.322-.478-.46-.744A6.7 6.7 0 0112 16.5c-.39 0-.77.05-1.135.143a3 3 0 01-2.049 1.188c-.17.228-.322.478-.46.744A6.7 6.7 0 017.5 19.5c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17.228-.322.478-.46.744A6.7 6.7 0 013 21c-.39 0-.77-.05-1.135-.143a3 3 0 01-2.049-1.188c-.17-.228-.322-.478-.46-.744A6.7 6.7 0 010 18c0-.39.05-.77.143-1.135a3 3 0 011.188-2.049c.228-.17.478.322.744-.46A6.7 6.7 0 013.75 12c0-.39.05-.77.143-1.135a3 3 0 011.188-2.049c.228-.17.478.322.744-.46A6.7 6.7 0 017.5 6c.39 0 .77.05 1.135.143a3 3 0 012.049-1.188c.17-.228.322.478.46-.744A6.7 6.7 0 0112 3c.39 0 .77.05 1.135.143a3 3 0 012.049-1.188c.17-.228.322-.478.46-.744A6.7 6.7 0 0116.5 0c.39 0 .77.05 1.135.143a3 3 0 012.049 1.188c.103.04.207.06.313.06zM12 15a3 3 0 100-6 3 3 0 000 6z" />
                    </svg>
                    <span>T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ</span>
                </button>
                <div id="keywords-results-container" class="mt-5 space-y-4 max-h-[550px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center">K·∫øt qu·∫£ t·∫°o t·ª´ kho√° s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Trang 2: Tr√¨nh L·∫•y Comment YouTube (·∫®n) -->
    <div id="page-comments" class="page container mx-auto p-4">
        <button class="back-button" data-page="page-hub">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Quay l·∫°i
        </button>
        <div class="comment-tool-container">
            <h1>üìù Tr√¨nh L·∫•y Comment YouTube</h1>
            <!-- H√†ng nh·∫≠p URL video -->
            <div class="comment-row">
                <div class="field"><input id="comment-video-url" class="comment-input" type="text" placeholder="D√°n link video YouTube v√†o ƒë√¢y..."></div>
                
                <!-- N√∫t ch·ªçn ng√¥n ng·ªØ M·ªöI -->
                <div class="relative">
                    <button id="lang-select-btn" class="lang-select-btn" type="button">
                        D·ªãch sang: <span>Ti·∫øng Vi·ªát</span>
                        <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="lang-dropdown" class="lang-dropdown">
                        <!-- C√°c ng√¥n ng·ªØ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                    </div>
                </div>

                <button id="comment-search-button" class="comment-btn">T√¨m ki·∫øm</button>
            </div>
            <!-- Thanh s·∫Øp x·∫øp -->
            <div class="sort-bar" id="comment-sort-bar">
                <span class="sort-title">S·∫Øp x·∫øp theo:</span>
                <button class="sort-btn" id="sort-like">Like ‚Üì</button>
                <button class="sort-btn" id="sort-replies">Cmt c·∫•p 2 ‚Üì</button>
                <button class="sort-btn" id="sort-date">Ng√†y ‚Üì</button>
                <span class="sort-hint">B·∫•m l·∫°i n√∫t ƒë·ªÉ ƒë·∫£o chi·ªÅu ‚Üë/‚Üì</span>
            </div>
            <div id="comment-status"></div>
            <div id="comment-results"></div>
        </div>
    </div>


    <script>
        // SCRIPT CHUNG: QU·∫¢N L√ù CHUY·ªÇN TRANG
        document.addEventListener('DOMContentLoaded', () => {
            const pages = document.querySelectorAll('.page');
            
            function showPage(pageId) {
                pages.forEach(page => {
                    page.classList.remove('active');
                });
                const newPage = document.getElementById(pageId);
                if (newPage) {
                    newPage.classList.add('active');
                    window.scrollTo(0, 0); // Cu·ªôn l√™n ƒë·∫ßu trang
                }
            }

            // G√°n s·ª± ki·ªán cho c√°c n√∫t quay l·∫°i
            document.querySelectorAll('.back-button').forEach(button => {
                button.addEventListener('click', () => {
                    showPage(button.dataset.page);
                });
            });

            // G√°n s·ª± ki·ªán cho c√°c card ·ªü trang ch·ªß
            document.querySelectorAll('.hub-card').forEach(card => {
                card.addEventListener('click', () => {
                    showPage(card.dataset.page);
                });
            });
            
            // --- KH·ªûI CH·∫†Y C√ÅC SCRIPT CHO T·ª™NG C√îNG C·ª§ ---
            initKeywordsTool();
            initCommentsTool();
        });


        // ==================================================================
        // === SCRIPT CHO C√îNG C·ª§ T·ª™ KH√ìA (Keywords Tool) ===
        // ==================================================================
        function initKeywordsTool() {
            const videoInputsContainer = document.getElementById('keywords-video-inputs');
            const searchButton = document.getElementById('keywords-search-button');
            const generateKeywordsButton = document.getElementById('keywords-generate-button');
            const keywordResultsContainer = document.getElementById('keywords-results-container');

            const NUM_INPUTS = 15;
            let videoDataStore = new Array(NUM_INPUTS).fill(null);

            // --- KH·ªûI T·∫†O GIAO DI·ªÜN ---
            function createInputRows() {
                if (!videoInputsContainer) return; // Ki·ªÉm tra n·∫øu kh√¥ng ·ªü ƒë√∫ng trang
                for (let i = 0; i < NUM_INPUTS; i++) {
                    const row = document.createElement('div');
                    row.className = 'flex items-center space-x-2 relative';
                    row.innerHTML = `
                        <span class="font-semibold text-gray-500 w-6 text-right">${i + 1}.</span>
                        <input type="text" data-index="${i}" class="video-url-input flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="D√°n link YouTube...">
                        <button data-index="${i}" class="info-btn w-28 bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition duration-300 hover:bg-gray-400">
                            Th√¥ng tin
                        </button>
                        <!-- Popover -->
                        <div class="popover bg-white border border-gray-300 rounded-lg shadow-xl p-4 right-0 top-10">
                            <p class="popover-placeholder text-gray-600">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "T√¨m ki·∫øm".</p>
                            <div class="popover-content hidden space-y-3">
                                <!-- Ti√™u ƒë·ªÅ -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="font-bold text-base text-gray-900 popover-title flex-1 break-words"></h4>
                                        <button class="popover-copy-btn" data-type="title">Copy</button>
                                    </div>
                                </div>
                                <!-- M√¥ t·∫£ -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">M√¥ t·∫£:</h5>
                                        <button class="popover-copy-btn" data-type="desc">Copy</button>
                                    </div>
                                    <p class="text-sm text-gray-700 popover-description">
                                        <span class="desc-short"></span>
                                        <span class="desc-full"></span>
                                        <button class="toggle-desc hidden">Xem th√™m</button>
                                    </p>
                                </div>
                                <!-- T·ª´ kh√≥a -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">T·ª´ kho√°:</h5>
                                        <button class="popover-copy-btn" data-type="tags">Copy</button>
                                    </div>
                                    <div class="flex flex-wrap gap-1 popover-tags"></div>
                                </div>
                                <!-- Hashtag -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h5 class="text-sm font-semibold text-gray-800">Hashtags:</h5>
                                        <button class="popover-copy-btn" data-type="hashtags">Copy</button>
                                    </div>
                                    <div class="flex flex-wrap gap-1 popover-hashtags"></div>
                                </div>
                            </div>
                        </div>`;
                    videoInputsContainer.appendChild(row);
                }
            }

            // --- LOGIC X·ª¨ L√ù S·ª∞ KI·ªÜN ---
            if(searchButton) { // Ch·ªâ g√°n s·ª± ki·ªán n·∫øu n√∫t t·ªìn t·∫°i
                searchButton.addEventListener('click', async () => {
                    setLoading(searchButton, true, "ƒêang t√¨m ki·∫øm...");
                    const inputs = document.querySelectorAll('.video-url-input');
                    const infoButtons = document.querySelectorAll('.info-btn');
                    const popovers = document.querySelectorAll('.popover');
                    
                    videoDataStore = new Array(NUM_INPUTS).fill(null); // Reset
                    let fetchPromises = [];

                    infoButtons.forEach((button, index) => {
                        updateInfoButton(button, null);
                        updatePopover(popovers[index], null);
                    });

                    inputs.forEach((input, index) => {
                        const url = input.value.trim();
                        const videoId = getYoutubeId(url);
                        const button = infoButtons[index];
                        const popover = popovers[index];
                        
                        if (videoId) {
                            fetchPromises.push(
                                fetchYouTubeVideoInfo(videoId)
                                    .then(data => {
                                        videoDataStore[index] = data;
                                        updatePopover(popover, data);
                                        updateInfoButton(button, true);
                                    })
                                    .catch(error => {
                                        console.error(`L·ªói khi fetch video ${videoId}:`, error);
                                        const errorData = { error: 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu' };
                                        videoDataStore[index] = errorData;
                                        updatePopover(popover, errorData);
                                        updateInfoButton(button, false);
                                    })
                            );
                        } else if (url !== "") { 
                            const errorData = { error: 'Link kh√¥ng h·ª£p l·ªá' };
                            videoDataStore[index] = errorData;
                            updatePopover(popover, errorData);
                            updateInfoButton(button, false);
                        }
                    });
                    await Promise.allSettled(fetchPromises);
                    setLoading(searchButton, false, "T√¨m ki·∫øm Th√¥ng Tin Video");
                });
            }

            if(generateKeywordsButton) { // Ch·ªâ g√°n s·ª± ki·ªán n·∫øu n√∫t t·ªìn t·∫°i
                generateKeywordsButton.addEventListener('click', async () => {
                    setLoading(generateKeywordsButton, true, "ƒêang t·∫°o...");
                    keywordResultsContainer.innerHTML = '<div class="flex justify-center items-center p-10"><div class="loader"></div><span class="ml-3">ƒêang li√™n h·ªá v·ªõi Gemini...</span></div>';

                    let combinedText = "";
                    videoDataStore.forEach(data => {
                        if (data && !data.error) {
                            combinedText += `Ti√™u ƒë·ªÅ: ${data.title}\n`;
                            combinedText += `M√¥ t·∫£: ${data.description}\n`;
                            if (data.tags && data.tags.length > 0) {
                                combinedText += `Tags: ${data.tags.join(', ')}\n`;
                            }
                            combinedText += "---\n";
                        }
                    });

                    if (combinedText.trim() === "") {
                        keywordResultsContainer.innerHTML = '<p class="text-red-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu video ƒë·ªÉ ph√¢n t√≠ch. Vui l√≤ng "T√¨m ki·∫øm" video tr∆∞·ªõc.</p>';
                        setLoading(generateKeywordsButton, false, "T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ");
                        return;
                    }

                    try {
                        const result = await callGeminiApi(combinedText);
                        displayKeywordResults(result);
                    } catch (error) {
                        console.error("L·ªói khi g·ªçi Gemini API:", error);
                        keywordResultsContainer.innerHTML = `<p class="text-red-500 text-center"><strong>ƒê√£ x·∫£y ra l·ªói:</strong> ${error.message}</p>`;
                    } finally {
                        setLoading(generateKeywordsButton, false, "T·∫°o B·ªô T·ª´ Kho√° C·ªßa Ch·ªß ƒê·ªÅ");
                    }
                });
            }

            // --- H√ÄM H·ªñ TR·ª¢ (Keywords Tool) ---
            function getYoutubeId(url) {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            async function fetchYouTubeVideoInfo(videoId) {
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: videoId })
                });
                if (!response.ok) {
                    let errorMessage = `L·ªói m√°y ch·ªß: ${response.status}`;
                    try { const errorData = await response.json(); errorMessage = errorData.message || JSON.stringify(errorData); } 
                    catch (e) { errorMessage = await response.text(); }
                    throw new Error(errorMessage);
                }
                return response.json();
            }

            function updateInfoButton(buttonElement, isSuccess) {
                buttonElement.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'bg-indigo-500', 'text-white', 'hover:bg-indigo-600', 'result-btn', 'bg-red-500', 'hover:bg-red-600');
                if (isSuccess === true) {
                    buttonElement.textContent = 'K·∫øt qu·∫£';
                    buttonElement.classList.add('bg-indigo-500', 'text-white', 'hover:bg-indigo-600', 'result-btn');
                } else if (isSuccess === false) {
                    buttonElement.textContent = 'L·ªói';
                    buttonElement.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                } else {
                    buttonElement.textContent = 'Th√¥ng tin';
                    buttonElement.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                }
            }

            function updatePopover(popoverElement, data) {
                const placeholder = popoverElement.querySelector('.popover-placeholder');
                const contentDiv = popoverElement.querySelector('.popover-content');

                if (data && !data.error) {
                    placeholder.classList.add('hidden');
                    contentDiv.classList.remove('hidden');

                    const { title, description, tags } = data;
                    const hashtagRegex = /#[\w\d_]+/g; // S·ª≠a l·∫°i regex cho hashtag
                    const foundHashtags = description.match(hashtagRegex) || [];

                    // 1. Ti√™u ƒë·ªÅ
                    contentDiv.querySelector('.popover-title').textContent = title;
                    contentDiv.querySelector('[data-type="title"]').dataset.copyText = title;

                    // 2. M√¥ t·∫£
                    const descP = contentDiv.querySelector('.popover-description');
                    const descShort = descP.querySelector('.desc-short');
                    const descFull = descP.querySelector('.desc-full');
                    const toggleBtn = descP.querySelector('.toggle-desc');
                    contentDiv.querySelector('[data-type="desc"]').dataset.copyText = description;

                    if (description.length > 120) {
                        descShort.textContent = description.substring(0, 120) + '...';
                        descFull.textContent = description;
                        toggleBtn.classList.remove('hidden');
                        descFull.style.display = 'none';
                        toggleBtn.textContent = 'Xem th√™m';
                        toggleBtn.onclick = () => {
                            const isHidden = descFull.style.display === 'none';
                            descFull.style.display = isHidden ? 'inline' : 'none';
                            toggleBtn.textContent = isHidden ? 'Thu g·ªçn' : 'Xem th√™m';
                        };
                    } else {
                        descShort.textContent = description;
                        descFull.textContent = '';
                        toggleBtn.classList.add('hidden');
                    }

                    // 3. T·ª´ kh√≥a (Tags)
                    const tagsContainer = contentDiv.querySelector('.popover-tags');
                    tagsContainer.innerHTML = '';
                    contentDiv.querySelector('[data-type="tags"]').dataset.copyText = tags.join(', ');
                    if (tags && tags.length > 0) {
                        tags.forEach(tag => {
                            const tagEl = document.createElement('span');
                            tagEl.className = 'bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs';
                            tagEl.textContent = tag;
                            tagsContainer.appendChild(tagEl);
                        });
                    } else {
                        tagsContainer.innerHTML = '<i class="text-gray-500 text-xs">Kh√¥ng c√≥ tags</i>';
                    }

                    // 4. Hashtags
                    const hashtagsContainer = contentDiv.querySelector('.popover-hashtags');
                    hashtagsContainer.innerHTML = '';
                    contentDiv.querySelector('[data-type="hashtags"]').dataset.copyText = foundHashtags.join(' ');
                    if (foundHashtags.length > 0) {
                        foundHashtags.forEach(tag => {
                            const tagEl = document.createElement('span');
                            tagEl.className = 'bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs';
                            tagEl.textContent = tag;
                            hashtagsContainer.appendChild(tagEl);
                        });
                    } else {
                        hashtagsContainer.innerHTML = '<i class="text-gray-500 text-xs">Kh√¥ng c√≥ hashtags</i>';
                    }
                    
                    // G√°n s·ª± ki·ªán cho c√°c n√∫t copy m·ªõi
                    contentDiv.querySelectorAll('.popover-copy-btn').forEach(btn => {
                        btn.onclick = () => copyToClipboard(btn.dataset.copyText, btn, true);
                    });

                } else {
                    placeholder.classList.remove('hidden');
                    contentDiv.classList.add('hidden');
                    if (data && data.error) {
                        placeholder.textContent = data.error;
                        placeholder.classList.add('text-red-500');
                    } else {
                        placeholder.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n "T√¨m ki·∫øm".';
                        placeholder.classList.remove('text-red-500');
                    }
                }
            }

            function setLoading(button, isLoading, loadingText) {
                if (!button.dataset.originalContent) {
                    button.dataset.originalContent = button.innerHTML;
                }
                const originalContent = button.dataset.originalContent;
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = `<div class="loader"></div><span>${loadingText}</span>`;
                } else {
                    button.disabled = false;
                    button.innerHTML = originalContent.replace(/<span>(.*?)<\/span>/, `<span>${loadingText}</span>`);
                }
            }

            async function callGeminiApi(promptText) {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText })
                });
                if (!response.ok) {
                    let errorMessage = `L·ªói m√°y ch·ªß: ${response.status}`;
                    try { const errorData = await response.json(); errorMessage = errorData.message || JSON.stringify(errorData); } 
                    catch (e) { errorMessage = await response.text(); }
                    throw new Error(errorMessage);
                }
                return await response.json();
            }

            function displayKeywordResults(data) {
                keywordResultsContainer.innerHTML = ''; // X√≥a

                const createSection = (title, content, copyText) => {
                    const section = document.createElement('div');
                    section.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center mb-3';
                    const titleEl = document.createElement('h3');
                    titleEl.className = 'text-lg font-semibold text-gray-800';
                    titleEl.textContent = title;
                    header.appendChild(titleEl);
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.dataset.copyText = copyText || ''; 
                    copyButton.addEventListener('click', () => copyToClipboard(copyButton.dataset.copyText, copyButton));
                    header.appendChild(copyButton);
                    section.appendChild(header);

                    if (Array.isArray(content) && content.length > 0) {
                        const list = document.createElement('div');
                        list.className = 'flex flex-wrap gap-2';
                        content.forEach(item => {
                            const itemEl = document.createElement('span');
                            itemEl.className = 'bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full';
                            itemEl.textContent = item;
                            list.appendChild(itemEl);
                        });
                        section.appendChild(list);
                    } else if (typeof content === 'string' && content) {
                        const contentEl = document.createElement('p');
                        contentEl.className = 'text-gray-700 whitespace-pre-wrap';
                        contentEl.textContent = content;
                        section.appendChild(contentEl);
                    } else {
                         const contentEl = document.createElement('p');
                        contentEl.className = 'text-gray-500 italic';
                        contentEl.textContent = (content && content.length === 0) ? 'Kh√¥ng c√≥' : 'N/A';
                        section.appendChild(contentEl);
                    }
                    keywordResultsContainer.appendChild(section);
                };

                createSection('B·ªô T·ª´ Kho√° Ch√≠nh', data.boTuKhoaChinh, data.boTuKhoaChinh.join(', '));
                createSection('T·ª´ Kho√° B·ªï Tr·ª£', data.tuKhoaBoTro, data.tuKhoaBoTro.join(', '));
                createSection('T·ª´ Kho√° Li√™n Quan', data.tuKhoaLienQuan, data.tuKhoaLienQuan.join(', '));
                createSection('T·ª´ Kho√° Th∆∞∆°ng Hi·ªáu', data.tuKhoaThuongHieu, data.tuKhoaThuongHieu.join(', '));
                createSection('Hashtags', data.hashtags, data.hashtags.join(' '));
                createSection('Ti√™u ƒê·ªÅ Ch·ªß ƒê·ªÅ (Danh s√°ch ph√°t)', data.tieuDeChuDe, data.tieuDeChuDe);
                createSection('M√¥ T·∫£ Ch·ªß ƒê·ªÅ (Danh s√°ch ph√°t)', data.moTaChuDe, data.moTaChuDe);
            }

            // H√†m Copy chung
            function copyToClipboard(text, buttonElement, isPopover = false) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed'; textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'ƒê√£ ch√©p!';
                    buttonElement.disabled = true;
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.disabled = false;
                    }, 2000);
                } catch (err) {
                    console.error('Kh√¥ng th·ªÉ copy:', err);
                    buttonElement.textContent = 'L·ªói';
                }
                document.body.removeChild(textArea);
            }

            // KH·ªûI ƒê·ªòNG
            createInputRows();
        }


        // ==================================================================
        // === SCRIPT CHO C√îNG C·ª§ COMMENT (Comments Tool) ===
        // ==================================================================
        function initCommentsTool() {
            // ===== UI refs =====
            const searchButton = document.getElementById('comment-search-button');
            const videoUrlInput = document.getElementById('comment-video-url');
            const resultsDiv = document.getElementById('comment-results');
            const statusDiv = document.getElementById('comment-status');
            const sortBar = document.getElementById('comment-sort-bar');
            const btnSortLike = document.getElementById('sort-like');
            const btnSortReplies = document.getElementById('sort-replies');
            const btnSortDate = document.getElementById('sort-date');
            
            // --- C√ÅC BI·∫æN CHO N√öT NG√îN NG·ªÆ ---
            const langSelectBtn = document.getElementById('lang-select-btn');
            const langDropdown = document.getElementById('lang-dropdown');
            const langBtnText = langSelectBtn.querySelector('span');
            let targetLang = 'vi'; // Ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh
            let targetLangName = 'Ti·∫øng Vi·ªát';

            const languages = [
                { code: 'vi', name: 'Ti·∫øng Vi·ªát' },
                { code: 'en', name: 'Ti·∫øng Anh' },
                { code: 'es', name: 'Ti·∫øng T√¢y Ban Nha' },
                { code: 'fr', name: 'Ti·∫øng Ph√°p' },
                { code: 'de', name: 'Ti·∫øng ƒê·ª©c' },
                { code: 'ja', name: 'Ti·∫øng Nh·∫≠t' },
                { code: 'ko', name: 'Ti·∫øng H√†n' },
                { code: 'zh-CN', name: 'Ti·∫øng Trung (Gi·∫£n th·ªÉ)' },
                { code: 'ru', name: 'Ti·∫øng Nga' },
                { code: 'pt', name: 'Ti·∫øng B·ªì ƒê√†o Nha' }
            ];

            // --- Kh·ªüi t·∫°o danh s√°ch ng√¥n ng·ªØ ---
            function initLanguageDropdown() {
                if(!langDropdown) return;
                langDropdown.innerHTML = '';
                languages.forEach(lang => {
                    const option = document.createElement('div');
                    option.className = 'lang-option';
                    option.textContent = lang.name;
                    option.dataset.code = lang.code;
                    option.dataset.name = lang.name;
                    if (lang.code === targetLang) {
                        option.classList.add('selected');
                    }
                    option.addEventListener('click', () => {
                        // C·∫≠p nh·∫≠t state
                        targetLang = lang.code;
                        targetLangName = lang.name;
                        
                        // C·∫≠p nh·∫≠t UI
                        langBtnText.textContent = lang.name;
                        langDropdown.querySelectorAll('.lang-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        langDropdown.classList.remove('show');
                    });
                    langDropdown.appendChild(option);
                });
            }

            // --- G√°n s·ª± ki·ªán cho n√∫t ng√¥n ng·ªØ ---
            if(langSelectBtn) {
                initLanguageDropdown();

                langSelectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langDropdown.classList.toggle('show');
                });
                
                // ƒê√≥ng dropdown khi click ra ngo√†i
                document.addEventListener('click', (e) => {
                    if (langSelectBtn && !langSelectBtn.contains(e.target) && langDropdown && !langDropdown.contains(e.target)) {
                        langDropdown.classList.remove('show');
                    }
                });
            }

            // ===== State =====
            let allThreads = [];
            let sortKey = 'date'; // 'like' | 'replies' | 'date'
            let sortDir = 'desc'; // 'asc' | 'desc'
            let allCommentTexts = []; // M·∫£ng ch·ª©a to√†n b·ªô vƒÉn b·∫£n g·ªëc
            let allTranslations = []; // M·∫£ng ch·ª©a to√†n b·ªô vƒÉn b·∫£n d·ªãch
            let currentTranslationHeader = 'B·∫£n d·ªãch (vi)'; // Bi·∫øn l∆∞u ti√™u ƒë·ªÅ c·ªôt d·ªãch

            // ===== Translation (Backend) =====
            async function translateBatchToVi(texts, langCode) {
                if (!texts || texts.length === 0) return [];
                
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c·ªôt d·ªãch
                // L·∫•y t√™n ng√¥n ng·ªØ t·ª´ m√£ code
                const langName = languages.find(l => l.code === langCode)?.name || langCode;
                currentTranslationHeader = `B·∫£n d·ªãch (${langName})`;
                statusDiv.textContent = `ƒêang d·ªãch ${texts.length} b√¨nh lu·∫≠n sang ${langName}... (ch·ªâ 1 l·∫ßn)`;
                
                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texts: texts, targetLang: langCode }) // G·ª≠i ng√¥n ng·ªØ ƒë√£ ch·ªçn
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'L·ªói d·ªãch');
                    }
                    
                    const data = await response.json();
                    return data.translations || texts.map(() => '(Ch∆∞a d·ªãch)');

                } catch (e) {
                    console.error('L·ªói g·ªçi backend d·ªãch:', e);
                    statusDiv.textContent = `L·ªói d·ªãch: ${e.message}`;
                    return texts.map(() => '(L·ªói d·ªãch)');
                }
            }

            // ===== Sort handlers =====
            function attachSortHandlers() {
                function activate(btn) { [btnSortLike, btnSortReplies, btnSortDate].forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
                function toggleDir(btn, label) { sortDir = (sortDir === 'desc') ? 'asc' : 'desc'; btn.textContent = `${label} ${sortDir === 'desc' ? '‚Üì' : '‚Üë'}`; }

                if (btnSortLike.hasAttribute('data-inited')) return; // ƒê√£ g√°n r·ªìi

                btnSortLike.addEventListener('click', () => {
                    if (sortKey !== 'like') { sortKey = 'like'; sortDir = 'desc'; btnSortLike.textContent = 'Like ‚Üì'; } 
                    else toggleDir(btnSortLike, 'Like');
                    activate(btnSortLike); renderThreads();
                });
                btnSortReplies.addEventListener('click', () => {
                    if (sortKey !== 'replies') { sortKey = 'replies'; sortDir = 'desc'; btnSortReplies.textContent = 'Cmt c·∫•p 2 ‚Üì'; } 
                    else toggleDir(btnSortReplies, 'Cmt c·∫•p 2');
                    activate(btnSortReplies); renderThreads();
                });
                btnSortDate.addEventListener('click', () => {
                    if (sortKey !== 'date') { sortKey = 'date'; sortDir = 'desc'; btnSortDate.textContent = 'Ng√†y ‚Üì'; } 
                    else toggleDir(btnSortDate, 'Ng√†y');
                    activate(btnSortDate); renderThreads();
                });
                
                btnSortDate.classList.add('active'); // K√≠ch ho·∫°t m·∫∑c ƒë·ªãnh
                btnSortLike.setAttribute('data-inited', '1');
            }

            // ===== Search flow =====
            if(searchButton) { // Ch·ªâ g√°n s·ª± ki·ªán n·∫øu n√∫t t·ªìn t·∫°i
                searchButton.addEventListener('click', async () => {
                    const videoURL = videoUrlInput.value.trim();
                    if (!videoURL) { alert('Vui l√≤ng nh·∫≠p link video YouTube.'); return; }
                    const videoId = getYoutubeId(videoURL);
                    if (!videoId) { alert('Link video kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.'); return; }

                    // Reset
                    searchButton.disabled = true; 
                    searchButton.innerHTML = '<div class="loader" style="width: 20px; height: 20px; border-width: 3px;"></div>'; // Loader nh·ªè h∆°n
                    resultsDiv.innerHTML = ''; statusDiv.textContent = 'ƒêang l·∫•y d·ªØ li·ªáu, vui l√≤ng ch·ªù...';
                    allThreads = []; allCommentTexts = []; allTranslations = [];
                    sortBar.style.display = 'none';

                    try {
                        // 1. L·∫•y t·∫•t c·∫£ b√¨nh lu·∫≠n
                        await fetchAllComments(videoId);
                        
                        if (allThreads.length === 0) {
                            statusDiv.textContent = 'Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n n√†o ho·∫∑c video ƒë√£ t·∫Øt b√¨nh lu·∫≠n.';
                            searchButton.disabled = false; searchButton.textContent = 'T√¨m ki·∫øm'; // Ph·ª•c h·ªìi n√∫t
                            return;
                        }
                        
                        // 2. T·ªêI ∆ØU: D·ªãch t·∫•t c·∫£ 1 l·∫ßn (s·ª≠ d·ª•ng targetLang)
                        allTranslations = await translateBatchToVi(allCommentTexts, targetLang);

                        // 3. Hi·ªÉn th·ªã
                        statusDiv.textContent = `ƒê√£ t·∫£i v√† d·ªãch xong ${allThreads.length} lu·ªìng b√¨nh lu·∫≠n!`;
                        attachSortHandlers();
                        sortBar.style.display = 'flex';
                        renderThreads(); // Render l·∫ßn ƒë·∫ßu (ƒë√£ d·ªãch)
                        
                    } catch (e) {
                        console.error('L·ªói:', e);
                        statusDiv.textContent = `ƒê√£ x·∫£y ra l·ªói: ${e.message}`;
                    } finally {
                        searchButton.disabled = false; searchButton.textContent = 'T√¨m ki·∫øm';
                    }
                });
            }

            function getYoutubeId(url) {
                const re = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const m = url.match(re); return m ? m[1] : null;
            }

            // ===== Fetch comments (paginate) =====
            async function fetchAllComments(videoId, pageToken = '') {
                statusDiv.textContent = `ƒêang t·∫£i b√¨nh lu·∫≠n... (ƒë√£ t·∫£i ${allThreads.length} lu·ªìng)`;
                
                // G·ªçi backend /api/youtube-comments
                const response = await fetch('/api/youtube-comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: videoId, pageToken: pageToken })
                });

                if (!response.ok) {
                    const errText = await response.text(); // L·∫•y l·ªói text
                    console.error("L·ªói fetchAllComments:", errText);
                    let errMessage = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
                    try {
                        const errJson = JSON.parse(errText); // Th·ª≠ parse JSON
                        errMessage = errJson.message || errText;
                    } catch(e) {
                        errMessage = errText; // N·∫øu kh√¥ng ph·∫£i JSON, d√πng text
                    }
                    throw new Error(errMessage);
                }

                const data = await response.json();
                
                if (data.items) {
                    collectThreads(data.items);
                }
                
                // ƒê·ªá quy n·∫øu c√≥ trang ti·∫øp theo
                if (data.nextPageToken) {
                    await fetchAllComments(videoId, data.nextPageToken);
                }
            }

            // T·ªêI ∆ØU: T√°ch bi·ªát vi·ªác Thu th·∫≠p (Collect) v√† D·ªãch (Translate)
            function collectThreads(items) {
                items.forEach(item => {
                    const top = item.snippet.topLevelComment?.snippet || {};
                    const likeCount = Number(top.likeCount || 0);
                    const totalReplies = Number(item.snippet.totalReplyCount || 0);
                    const publishedAtISO = top.publishedAt || null;
                    const publishedDate = publishedAtISO ? new Date(publishedAtISO) : null;
                    
                    const threadObj = {
                        raw: item,
                        likeCount, totalReplies,
                        publishedAtISO, publishedDate,
                        translationIndexStart: allCommentTexts.length // V·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa b·∫£n d·ªãch
                    };

                    // Thu th·∫≠p vƒÉn b·∫£n g·ªëc (top level)
                    allCommentTexts.push(top.textOriginal || '');
                    
                    // Thu th·∫≠p vƒÉn b·∫£n g·ªëc (replies)
                    (item.replies?.comments || []).forEach(r => {
                        allCommentTexts.push(r.snippet?.textOriginal || '');
                    });
                    
                    allThreads.push(threadObj);
                });
            }

            // ===== Render (ch·ªâ s·∫Øp x·∫øp v√† hi·ªÉn th·ªã) =====
            function renderThreads() {
                // S·∫Øp x·∫øp
                const arr = [...allThreads];
                arr.sort((a, b) => {
                    let va, vb;
                    if (sortKey === 'like') { va = a.likeCount; vb = b.likeCount; } 
                    else if (sortKey === 'replies') { va = a.totalReplies; vb = b.totalReplies; } 
                    else {
                        va = a.publishedDate ? a.publishedDate.getTime() : 0;
                        vb = b.publishedDate ? b.publishedDate.getTime() : 0;
                    }
                    return (sortDir === 'desc') ? (vb - va) : (va - vb);
                });

                // Render
                resultsDiv.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©
                for (const obj of arr) {
                    // B√¢y gi·ªù ch·ªâ c·∫ßn t·∫°o DOM, kh√¥ng c·∫ßn ch·ªù d·ªãch
                    resultsDiv.appendChild(createThreadDOM(obj));
                }
            }

            // ===== DOM builders =====
            function createThreadDOM(threadObj) {
                const { raw, likeCount, totalReplies, publishedAtISO, publishedDate, translationIndexStart } = threadObj;
                const top = raw.snippet.topLevelComment.snippet;

                const threadDiv = document.createElement('div'); threadDiv.className = 'comment-thread';
                const rowDiv = document.createElement('div'); rowDiv.className = 'thread-row';

                // Tr√°i: 2 c·ªôt (Nguy√™n b·∫£n | D·ªãch)
                const leftWrap = document.createElement('div'); leftWrap.className = 'left-grid';

                // C·ªôt Nguy√™n b·∫£n
                const colOriginal = document.createElement('div'); colOriginal.className = 'left-col';
                colOriginal.innerHTML = `<h3>Nguy√™n b·∫£n</h3>`;
                colOriginal.appendChild(createCommentElement(top, false, null)); // textDisplay g·ªëc
                if (raw.replies) {
                    const rep = document.createElement('div'); rep.className = 'replies-container';
                    raw.replies.comments.forEach(r => rep.appendChild(createCommentElement(r.snippet, true, null)) );
                    colOriginal.appendChild(rep);
                }

                // C·ªôt D·ªãch (l·∫•y t·ª´ m·∫£ng ƒë√£ d·ªãch)
                const colTranslated = document.createElement('div'); colTranslated.className = 'left-col';
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c·ªôt d·ªãch
                colTranslated.innerHTML = `<h3>${currentTranslationHeader}</h3>`; 
                
                // L·∫•y b·∫£n d·ªãch cho top-level comment
                let translationIndex = translationIndexStart;
                const topLevelTranslation = allTranslations[translationIndex] || '(Ch∆∞a d·ªãch)';
                colTranslated.appendChild(createCommentElement(top, false, topLevelTranslation));
                translationIndex++; // TƒÉng ch·ªâ s·ªë
                
                if (raw.replies) {
                    const repVi = document.createElement('div'); repVi.className = 'replies-container';
                    raw.replies.comments.forEach(r => {
                        const replyTranslation = allTranslations[translationIndex] || '(Ch∆∞a d·ªãch)';
                        repVi.appendChild(createCommentElement(r.snippet, true, replyTranslation));
                        translationIndex++; // TƒÉng ch·ªâ s·ªë cho m·ªói reply
                    });
                    colTranslated.appendChild(repVi);
                }

                leftWrap.appendChild(colOriginal);
                leftWrap.appendChild(colTranslated);

                // Ph·∫£i: 3 ch·ªâ s·ªë
                const rightDiv = document.createElement('div'); rightDiv.className = 'thread-right';
                const metrics = document.createElement('div'); metrics.className = 'metrics-grid';

                const likeBox = document.createElement('div'); likeBox.className = 'metric';
                likeBox.innerHTML = `<div class="metric-label">Like (c·∫•p 1)</div><div class="metric-value">${likeCount.toLocaleString('vi-VN')}</div>`;
                const replyBox = document.createElement('div'); replyBox.className = 'metric';
                replyBox.innerHTML = `<div class="metric-label">Cmt c·∫•p 2</div><div class="metric-value">${totalReplies.toLocaleString('vi-VN')}</div>`;
                const dateBox = document.createElement('div'); dateBox.className = 'metric';
                const dateText = publishedDate ? publishedDate.toLocaleString('vi-VN', { hour12: false }) : '‚Äî';
                dateBox.innerHTML = `<div class="metric-label">Ng√†y</div><div class="metric-value" title="${publishedAtISO || ''}">${dateText}</div>`;

                metrics.appendChild(likeBox); metrics.appendChild(replyBox); metrics.appendChild(dateBox);
                rightDiv.appendChild(metrics);

                rowDiv.appendChild(leftWrap);
                rowDiv.appendChild(rightDiv);
                threadDiv.appendChild(rowDiv);
                return threadDiv;
            }

            function createCommentElement(snippet, isReply = false, overrideText = null) {
                const wrap = document.createElement('div'); wrap.className = isReply ? 'comment reply' : 'comment';
                const avatar = document.createElement('img');
                avatar.className = 'comment-author-img'; 
                avatar.src = snippet.authorProfileImageUrl; 
                avatar.alt = 'Avatar';
                avatar.onerror = () => { avatar.src = 'https://placehold.co/40x40/eee/ccc?text=?'; }; // ·∫¢nh placeholder n·∫øu l·ªói
                
                const content = document.createElement('div'); content.className = 'comment-content';
                const author = document.createElement('div'); author.className = 'comment-author';
                author.textContent = snippet.authorDisplayName || '(Kh√¥ng r√µ)';
                
                const text = document.createElement('div');
                text.style.whiteSpace = 'pre-wrap'; // Gi·ªØ xu·ªëng d√≤ng
                text.style.wordBreak = 'break-word'; // Ng·∫Øt t·ª´
                
                if (overrideText !== null) { 
                    text.textContent = overrideText; // Hi·ªÉn th·ªã text thu·∫ßn (ƒë√£ d·ªãch)
                } else { 
                    text.innerHTML = snippet.textDisplay || snippet.textOriginal; // Hi·ªÉn th·ªã HTML g·ªëc
                }

                content.appendChild(author); content.appendChild(text);
                wrap.appendChild(avatar); wrap.appendChild(content);
                return wrap;
            }
        } // K·∫øt th√∫c initCommentsTool()
    </script>
</body>
</html>

